<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LEAP Section 16 Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <style>
    html, body, #container { margin:0; padding:0; height:100%; }
    body { font-family: Arial, sans-serif; }
    #container { display:flex; height:100%; }

    /* Map */
    #mapPane { position:relative; flex:1; min-width: 340px; }
    #viewDiv { width:100%; height:100%; }

    /* Assessment panel (right) */
    #infoPane{
      width: 420px;
      min-width: 420px;
      background:#f5f5f5;
      overflow-y:auto;
      padding:20px;
      box-sizing:border-box;
      border-left:1px solid #e1e1e1;
      transition: width .28s ease, min-width .28s ease;
    }
    .app--parcel-selected #infoPane{
      width: 36vw;
      min-width: 520px;
    }

    #infoPane h2{ margin:0 0 8px; color:#003087; }
    #infoPane h3{
      margin:16px 0 8px;
      font-size:1.05em; font-weight:600; color:#003087;
      display:flex; align-items:center; gap:8px;
    }

    .rel-chip{
      font-size:.85em;
      border:1px solid #c9c9c9; background:#fff; border-radius:999px;
      padding:2px 10px; cursor:pointer; display:inline-flex; align-items:center; gap:6px;
    }
    .rel-chip .badge{
      display:inline-block; min-width:18px; height:18px; line-height:18px;
      text-align:center; font-size:.8em; border-radius:9px; background:#eee; border:1px solid #bbb;
    }

    .assessment-table { width:100%; border-collapse:collapse; table-layout:fixed; }
    .assessment-table th{ text-align:left; padding:6px 8px; vertical-align:top; width:34%; }
    .assessment-table td{ padding:6px 8px; vertical-align:top; }
    .assessment-table input, .assessment-table textarea{
      width:100%; box-sizing:border-box; padding:8px 10px; font-size:1rem;
      border:1px solid #cfcfcf; border-radius:6px; background:#fff;
    }
    .assessment-table input{ min-height:36px; }
    .assessment-table textarea{ min-height:90px; resize:vertical; line-height:1.35; }

    .field-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:6px; }
    .pill{
      padding:4px 10px; border:1px solid #c9c9c9; border-radius:999px; background:#fff; cursor:pointer;
      font-size:.9em; display:inline-flex; align-items:center; gap:6px;
    }

    .btn{ background:#003087; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
    .btn:disabled{ background:#a9a9a9; cursor:not-allowed; }

    /* Related drawer (far right) */
    #relatedPane{
      width: 360px; min-width: 320px; background:#fff; border-left:1px solid #e1e1e1;
      box-shadow: -10px 0 20px rgba(0,0,0,.06); display:none; padding:12px; box-sizing:border-box;
    }
    .app--related-open #relatedPane{ display:block; }
    #relatedHead{ display:flex; align-items:center; justify-content:space-between; }
    .tabs{ display:flex; gap:8px; margin:10px 0 12px; }
    .tab{ padding:6px 10px; border:1px solid #c9c9c9; border-radius:999px; background:#f8f8f8; cursor:pointer; display:inline-flex; align-items:center; gap:6px; }
    .tab.active{ background:#fff; border-color:#888; }
    .list{ display:flex; flex-direction:column; gap:10px; }
    .card{ border:1px solid #eee; border-radius:8px; padding:10px; }
    .row{ display:flex; gap:8px; }
    .row > * { flex:1; }
    .small{ font-size:.92em; color:#333; }
    .muted{ color:#666; font-size:.9em; }
  </style>
</head>
<body>
  <div id="container">
    <div id="mapPane"><div id="viewDiv"></div></div>

    <div id="infoPane">
      <h2>Section 16 Assessment</h2>
      <p id="startHint">Select a parcel on the map or search a Lot/Plan to begin.</p>

      <div id="formFields" style="display:none;">
        <!-- Parcel Details -->
        <h3>Parcel Details</h3>
        <table class="assessment-table">
          <tr><th>Lot/Plan</th>                 <td><input id="lotplan"     disabled /></td></tr>
          <tr><th>Lot</th>                      <td><input id="lot"         disabled /></td></tr>
          <tr><th>Plan</th>                     <td><input id="plan"        disabled /></td></tr>
          <tr><th>Survey Indicator</th>         <td><input id="surv_ind"    disabled /></td></tr>
          <tr><th>Title Reference</th>          <td><input id="title_ref"             /></td></tr>
          <tr><th>Property Address</th>         <td><input id="prop_addr"             /></td></tr>
          <tr><th>Area (ha)</th>                <td><input id="lot_area_c"            /></td></tr>
          <tr><th>Tenure</th>                   <td><input id="tenure"       disabled /></td></tr>
          <tr><th>Registered Owner/Trustee</th> <td><input id="reg_owner"            /></td></tr>
          <tr><th>Local Government Area</th>    <td><input id="shire_name"   disabled /></td></tr>
        </table>

        <!-- Administrative Attributes -->
        <h3>Administrative Attributes</h3>
        <table class="assessment-table">
          <tr><th>Access (Legal)</th>       <td><input id="access_l"    /></td></tr>
          <tr><th>Access (Practical)</th>   <td><input id="access_p"    /></td></tr>
          <tr><th>Registered Interests</th> <td><input id="ciram_chk"   /></td></tr>
          <tr><th>Current Valuation</th>    <td><input id="qvas_val"    /></td></tr>
          <tr><th>eLVAS Cases</th>          <td><input id="elvas_ref"   /></td></tr>
        </table>

        <!-- Site History & Background -->
        <h3>
          Site History &amp; Background
          <span class="rel-chip" id="openNotes" title="View notes for this parcel">Notes <span class="badge" id="badgeNotes">0</span></span>
        </h3>
        <table class="assessment-table">
          <tr><th>Native Title Status</th>      <td><input id="nt_status"      /></td></tr>
          <tr><th>Indigenous Cult Heritage</th> <td><input id="ind_cul_he"     /></td></tr>
          <tr><th>Qld Cult Heritage</th>        <td><input id="qld_cul_he"     /></td></tr>
          <tr><th>Historical Tenure</th>        <td><input id="ten_hist"       /></td></tr>
        </table>

        <!-- Physical, Biological & Economic -->
        <h3>Physical, Biological &amp; Economic</h3>
        <table class="assessment-table">
          <tr><th>Parcel Type</th>     <td><input id="parcel_typ"  /></td></tr>
          <tr><th>Cover Type</th>      <td><input id="cover_typ"   /></td></tr>
          <tr>
            <th>Plan Constraints</th>
            <td>
              <textarea id="plan_const"></textarea>
              <div class="field-actions">
                <span class="pill" id="openAttach" title="View/Add attachments">Attachments <span class="badge" id="badgeAttach">0</span></span>
              </div>
            </td>
          </tr>
          <tr><th>MAUT Use</th>        <td><input id="mau"         /></td></tr>
          <tr><th>Past Material</th>   <td><input id="p_mat"       /></td></tr>
          <tr><th>Mining Interest</th> <td><input id="mine_int"    /></td></tr>
          <tr><th>EPM App/Grant</th>   <td><input id="epm_app" /><br/><input id="epm_granted" placeholder="Granted" /></td></tr>
          <tr><th>ML Permit App/Grant</th><td><input id="ml_permit_app" /><br/><input id="ml_granted" placeholder="Granted" /></td></tr>
          <tr><th>Exploration Permit</th> <td><input id="appln_int" /></td></tr>
        </table>

        <!-- Environment & Planning -->
        <h3>Environment &amp; Planning</h3>
        <table class="assessment-table">
          <tr><th>Contaminated Land</th>  <td><input id="contam_lan"     /></td></tr>
          <tr><th>Stock Route</th>        <td><input id="stk_route"      /></td></tr>
          <tr><th>State Plan Policy</th>  <td><input id="plan_schem"     /></td></tr>
          <tr><th>Regional Plan</th>      <td><textarea id="regional_plan"></textarea></td></tr>
          <tr><th>Flood Hazard</th>       <td><input id="flooding"       /></td></tr>
          <tr><th>Bushfire Hazard</th>    <td><input id="bushfire"       /></td></tr>
          <tr><th>Coastal Management</th> <td><input id="coastal_mgmt"   /></td></tr>
          <tr><th>Veg Mgmt Categories</th><td><input id="veg_mgmt_cat"   /></td></tr>
          <tr><th>Veg Mgmt Reg Ecos</th>  <td><input id="veg_mgmt_reg_eco"/></td></tr>
        </table>

        <!-- Social & Cultural -->
        <h3>Social &amp; Cultural Attributes</h3>
        <table class="assessment-table">
          <tr><th>Heritage Mgmt Plan</th><td><textarea id="cul_mgmt_plan"></textarea></td></tr>
          <tr><th>Study Area Bdy</th>    <td><textarea id="cul_studyarea_bdy"></textarea></td></tr>
          <tr><th>Party</th>             <td><input id="cul_party" /></td></tr>
        </table>

        <div style="margin-top:12px; text-align:right;">
          <button id="saveBtn" class="btn" disabled>Save</button>
          <button id="reportBtn" class="btn" disabled>Report</button>
        </div>
      </div>
    </div>

    <!-- Related Drawer -->
    <div id="relatedPane">
      <div id="relatedHead">
        <strong>Related</strong>
        <button id="closeRelated" class="btn" style="background:#666">Close</button>
      </div>
      <div class="tabs">
        <div class="tab active" data-tab="notes">Notes <span class="badge" id="tabBadgeNotes">0</span></div>
        <div class="tab" data-tab="attach">Attachments <span class="badge" id="tabBadgeAttach">0</span></div>
      </div>
      <div id="relatedActions" class="row" style="margin-bottom:10px;"></div>
      <div id="relatedContent" class="list"></div>
    </div>
  </div>

  <script src="https://js.arcgis.com/4.29/"></script>
  <script>
  require([
    "esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/layers/GraphicsLayer",
    "esri/Graphic","esri/widgets/Zoom","esri/widgets/Search"
  ], function(Map, MapView, FeatureLayer, GraphicsLayer, Graphic, Zoom, Search) {

    // === New UAT service (from your doc) ===
    const BASE = "https://uat-qportal.information.qld.gov.au/arcgis/rest/services/LEAP_ClaimParcels_rbt/FeatureServer";
    const CLAIM_LAYER_URL = BASE + "/0";  // LEAP_ClaimParcels_rbt (Layer 0)
    const NOTES_TABLE_URL = BASE + "/1";  // LEAP_S16_AssmtNotes_rbt (Table 1)
    const ATTACH_TABLE_URL = BASE + "/2"; // LEAP_S16_Attachments (Table 2)

    // Map + view
    const map = new Map({ basemap: "satellite" });
    const view = new MapView({ container: "viewDiv", map, zoom: 6, center: [145, -24] });

    // Layers
    const claimLayer = new FeatureLayer({ url: CLAIM_LAYER_URL, outFields: ["*"] });
    const notesTable = new FeatureLayer({ url: NOTES_TABLE_URL, outFields: ["*"] });
    const attachTable = new FeatureLayer({ url: ATTACH_TABLE_URL, outFields: ["*"] });

    const highlightLayer = new GraphicsLayer();
    map.addMany([claimLayer, highlightLayer]);

    // Zoom widget
    view.when(() => {
      view.ui.remove("zoom");
      view.ui.add(new Zoom({ view }), "top-left");
    });

    // Search on map top-right (Lot/Plan)
    const searchWidget = new Search({
      view: view,
      allPlaceholder: "Search Lot/Plan e.g. 45SP164230",
      includeDefaultSources: false,
      sources: [{
        layer: claimLayer,
        searchFields: ["lotplan"],
        displayField: "lotplan",
        exactMatch: false,
        outFields: ["*"],
        name: "Claim Parcels",
        placeholder: "e.g. 45SP164230"
      }]
    });
    view.ui.add(searchWidget, "top-right");

    // DOM
    const startHint  = document.getElementById("startHint");
    const formFields = document.getElementById("formFields");
    const saveBtn    = document.getElementById("saveBtn");
    const reportBtn  = document.getElementById("reportBtn");

    const openNotes  = document.getElementById("openNotes");
    const openAttach = document.getElementById("openAttach");
    const closeRelated = document.getElementById("closeRelated");

    const badgeNotes = document.getElementById("badgeNotes");
    const badgeAttach= document.getElementById("badgeAttach");
    const tabBadgeNotes = document.getElementById("tabBadgeNotes");
    const tabBadgeAttach= document.getElementById("tabBadgeAttach");
    const relatedContent = document.getElementById("relatedContent");
    const relatedActions = document.getElementById("relatedActions");

    document.querySelectorAll(".tab").forEach(t=>{
      t.addEventListener("click", ()=> {
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        renderRelated();
      });
    });
    closeRelated.addEventListener("click", ()=> document.body.classList.remove("app--related-open"));
    openNotes .addEventListener("click", ()=> { openRelated("notes"); });
    openAttach.addEventListener("click", ()=> { openRelated("attach"); });

    // State
    let selectedFeature = null;
    let attachDomain = []; // coded values from ATTACH_TABLE_URL.attach_category

    // Load domain for attach_category
    attachTable.load().then(()=>{
      const f = attachTable.fields.find(f => f.name.toLowerCase() === "attach_category");
      if (f && f.domain && f.domain.codedValues) {
        attachDomain = f.domain.codedValues.map(cv => ({ code: cv.code, name: cv.name }));
      }
    });

    // Init
    claimLayer.when(() => view.goTo(claimLayer.fullExtent));
    searchWidget.on("select-result", (evt) => { if (evt.result.feature) onSelectFeature(evt.result.feature); });
    view.on("click", (evt) => {
      view.hitTest(evt).then((r) => {
        const hit = r.results.find(x => x.graphic && x.graphic.layer === claimLayer);
        if (hit) onSelectFeature(hit.graphic); else clearSelection();
      });
    });
    clearSelection();

    function setAppSelected(on){ document.body.classList.toggle("app--parcel-selected", !!on); }
    function openRelated(which){
      document.body.classList.add("app--related-open");
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      document.querySelector(`.tab[data-tab="${which}"]`).classList.add("active");
      renderRelated();
    }

    function clearSelection(){
      highlightLayer.removeAll();
      selectedFeature = null;
      startHint.style.display  = "block";
      formFields.style.display = "none";
      saveBtn.disabled = reportBtn.disabled = true;
      setAppSelected(false);
      updateRelatedBadges(0,0);
      relatedContent.innerHTML = "";
      relatedActions.innerHTML = "";
    }

    function onSelectFeature(feature){
      selectedFeature = feature;
      fillForm(feature);
      highlight(feature);
      setAppSelected(true);
      startHint.style.display  = "none";
      formFields.style.display = "block";
      saveBtn.disabled = reportBtn.disabled = false;
      refreshRelatedCounts().catch(console.warn);
      // If drawer is open, refresh its contents for this parcel
      if (document.body.classList.contains("app--related-open")) renderRelated();
    }

    function fillForm(feature){
      const attrs = feature.attributes || {};
      for (const [k,v0] of Object.entries(attrs)){
        const el = document.getElementById(k);
        if (!el) continue;
        let v = v0;
        if (k === "lot_area" && v != null) v = (v/10000).toFixed(3); // m² -> ha (if lot_area present)
        el.value = (v == null ? "" : v);
      }
    }

    function highlight(feature){
      highlightLayer.removeAll();
      highlightLayer.add(new Graphic({
        geometry: feature.geometry,
        symbol: { type:"simple-fill", color:[255,255,0,0.3], outline:{ color:"yellow", width:2 } }
      }));
      const padded = feature.geometry.extent.expand(1.2);
      view.goTo(padded).catch(()=>{});
    }

    // Save edits (parcels)
    saveBtn.addEventListener("click", () => {
      if (!selectedFeature) return;
      const upd = { ...selectedFeature.attributes };
      Object.keys(upd).forEach(k => {
        const el = document.getElementById(k);
        if (el && !el.disabled) upd[k] = el.value;
      });
      claimLayer.applyEdits({ updateFeatures: [{ attributes: upd }]})
        .then(()=> alert("Saved"))
        .catch(e => alert("Save error: " + e.message));
    });

    // Report (stub)
    reportBtn.addEventListener("click", ()=> alert("Generate PDF here"));

    // --- Related data wiring using key fields from your doc ---

    async function refreshRelatedCounts(){
      if (!selectedFeature) { updateRelatedBadges(0,0); return; }
      const parcelGID = selectedFeature.attributes["globalid"];
      if (!parcelGID){ updateRelatedBadges(0,0); return; }

      // Count NOTES by parcelguid = parcel.globalid
      let notesCount = 0;
      const notesRes = await notesTable.queryFeatureCount({
        where: `parcelguid = '${parcelGID}'`
      }).catch(()=>0);
      notesCount = notesRes || 0;

      // Count ATTACHMENTS by parent_guid IN (notes.globalid for this parcel)
      let attachCount = 0;
      if (notesCount > 0){
        const notes = await notesTable.queryFeatures({
          where: `parcelguid = '${parcelGID}'`,
          outFields: ["globalid"], returnGeometry:false
        });
        const gids = (notes.features || []).map(f => `'${f.attributes.globalid}'`);
        if (gids.length){
          const where = `parent_guid IN (${gids.join(",")})`;
          attachCount = await attachTable.queryFeatureCount({ where }).catch(()=>0);
        }
      }
      updateRelatedBadges(notesCount, attachCount);
    }

    function updateRelatedBadges(n,a){
      badgeNotes.textContent = n; tabBadgeNotes.textContent = n;
      badgeAttach.textContent = a; tabBadgeAttach.textContent = a;
    }

    function currentTab(){
      const active = document.querySelector(".tab.active");
      return active ? active.getAttribute("data-tab") : "notes";
    }

    function setRelatedActions(which){
      // Build simple action row depending on tab
      relatedActions.innerHTML = "";
      if (!selectedFeature) return;
      if (which === "notes"){
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = "New Note";
        btn.onclick = createNoteForParcel;
        relatedActions.appendChild(btn);
      } else {
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = "New Attachment";
        btn.onclick = createAttachmentForFirstNote; // simple flow: attach to first note row
        relatedActions.appendChild(btn);
      }
    }

    async function renderRelated(){
      if (!selectedFeature){ relatedContent.innerHTML = ""; return; }
      const which = currentTab();
      setRelatedActions(which);
      relatedContent.innerHTML = "";

      const parcelGID = selectedFeature.attributes["globalid"];
      if (!parcelGID) { relatedContent.innerHTML = "<div class='card'>Missing parcel globalid.</div>"; return; }

      if (which === "notes"){
        const res = await notesTable.queryFeatures({
          where: `parcelguid = '${parcelGID}'`,
          outFields: ["*"], returnGeometry:false, orderByFields:["created_date ASC"]
        });
        const rows = res.features || [];
        if (!rows.length){
          relatedContent.innerHTML = "<div class='card'>No notes yet for this parcel.</div>";
          return;
        }
        rows.forEach((r, i) => {
          const at = r.attributes;
          const div = document.createElement("div");
          div.className = "card small";
          const rp   = at["regional_plan"] ?? "";
          const rpn  = at["regional_plan_notes"] ?? "";
          const summ = at["eval_summ"] ?? "";
          div.innerHTML = `
            <strong>Note ${i+1}</strong>
            <div class="muted">globalid: ${at.globalid}</div>
            ${rp || rpn || summ ? `
              <div style="margin-top:6px">
                ${rp ? `<div><b>Regional Plan:</b> ${rp}</div>` : "" }
                ${rpn? `<div><b>Regional Notes:</b> ${rpn}</div>`: "" }
                ${summ? `<div><b>Summary:</b> ${summ}</div>`: "" }
              </div>` : `
              <div class="muted" style="margin-top:6px">No highlighted fields; showing all:</div>
            `}
            <pre style="white-space:pre-wrap; margin:8px 0 0 0;">${JSON.stringify(at, null, 2)}</pre>
          `;
          relatedContent.appendChild(div);
        });
      } else {
        // Attachments: show for all notes of this parcel
        const notes = await notesTable.queryFeatures({
          where: `parcelguid = '${parcelGID}'`,
          outFields: ["globalid","s16_lotplan"], returnGeometry:false
        });
        const gids = (notes.features||[]).map(f => `'${f.attributes.globalid}'`);
        if (!gids.length){
          relatedContent.innerHTML = "<div class='card'>No notes yet; add a Note first, then attach.</div>";
          return;
        }
        const where = `parent_guid IN (${gids.join(",")})`;
        const res = await attachTable.queryFeatures({
          where, outFields:["*"], returnGeometry:false, orderByFields:["created_date ASC"]
        });
        const rows = res.features || [];
        if (!rows.length){
          relatedContent.innerHTML = "<div class='card'>No attachments yet for this parcel.</div>";
          return;
        }
        rows.forEach((r, i) => {
          const at = r.attributes;
          const div = document.createElement("div");
          div.className = "card small";
          div.innerHTML = `
            <strong>Attachment ${i+1}</strong>
            <div class="muted">parent_guid: ${at.parent_guid}</div>
            <div>attach_category: ${at.attach_category ?? ""}</div>
            <div>attach_name: ${at.attach_name ?? ""}</div>
            <pre style="white-space:pre-wrap; margin:8px 0 0 0;">${JSON.stringify(at, null, 2)}</pre>
          `;
          relatedContent.appendChild(div);
        });
      }
      // update badges after render (counts may have changed)
      refreshRelatedCounts().catch(()=>{});
    }

    async function createNoteForParcel(){
      if (!selectedFeature) return;
      const parcelGID = selectedFeature.attributes["globalid"];
      const lotplan   = selectedFeature.attributes["lotplan"] || "";
      const attrs = {
        parcelguid: parcelGID,    // link to parent parcel
        s16_lotplan: lotplan      // convenience copy
      };
      try{
        const res = await notesTable.applyEdits({ addFeatures: [{ attributes: attrs }] });
        if (res.addFeatureResults?.[0]?.objectId){
          alert("New note added.");
          renderRelated();
        } else {
          throw new Error(res.toString());
        }
      }catch(e){ alert("Error creating note: " + e.message); }
    }

    async function createAttachmentForFirstNote(){
      if (!selectedFeature) return;
      // Find first note for this parcel
      const parcelGID = selectedFeature.attributes["globalid"];
      const notes = await notesTable.queryFeatures({
        where: `parcelguid = '${parcelGID}'`,
        outFields: ["globalid"], returnGeometry:false, orderByFields:["created_date ASC"]
      });
      if (!notes.features?.length){
        alert("No notes found. Create a Note first.");
        return;
      }
      const noteGID = notes.features[0].attributes.globalid;

      // Simple prompt flow for demo (replace with proper form UI later)
      const name = prompt("Attachment name?");
      if (name == null) return;

      // Choose category (first CV as default)
      let cat = (attachDomain[0]?.code) || "";
      if (attachDomain.length){
        const list = attachDomain.map(cv => `${cv.code} — ${cv.name}`).join("\n");
        const inp = prompt("Attachment category code?\n\n" + list + "\n\nEnter code exactly:");
        if (inp != null && attachDomain.some(cv => cv.code === inp)) cat = inp;
      }

      const attrs = {
        parent_guid: noteGID,     // link to note
        attach_name: name,
        attach_category: cat
      };
      try{
        const res = await attachTable.applyEdits({ addFeatures: [{ attributes: attrs }] });
        if (res.addFeatureResults?.[0]?.objectId){
          alert("Attachment (metadata) added.");
          renderRelated();
        } else {
          throw new Error(res.toString());
        }
      }catch(e){ alert("Error creating attachment: " + e.message); }
    }

  });
  </script>
</body>
</html>
