<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LEAP Section 16 Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <style>
    :root{
      --info-width: 420px;
      --info-wide-min: 520px;
      --related-width: 360px;      /* normal drawer */
      --related-width-wide: 46vw;  /* wide drawer ~ your blue line */
    }

    html, body, #container { margin:0; padding:0; height:100%; }
    body { font-family: Arial, sans-serif; }
    #container { display:flex; height:100%; width:100%; overflow:hidden; }

    /* Map column never collapses */
    #mapPane { position:relative; flex:1 1 auto; min-width: 380px; }
    #viewDiv { width:100%; height:100%; }

    /* Assessment panel (right) */
    #infoPane{
      flex: 0 0 auto;
      width: var(--info-width);
      min-width: var(--info-width);
      background:#f5f5f5;
      overflow-y:auto;
      padding:20px;
      box-sizing:border-box;
      border-left:1px solid #e1e1e1;
      transition: width .28s ease, min-width .28s ease;
    }
    .app--parcel-selected #infoPane{
      width: 36vw;
      min-width: var(--info-wide-min);
    }

    #infoPane h2{ margin:0 0 8px; color:#003087; }
    #infoPane h3{
      margin:16px 0 8px;
      font-size:1.05em; font-weight:600; color:#003087;
      display:flex; align-items:center; gap:8px;
    }

    .rel-chip{
      font-size:.85em;
      border:1px solid #c9c9c9; background:#fff; border-radius:999px;
      padding:2px 10px; cursor:pointer; display:inline-flex; align-items:center; gap:6px;
    }
    .rel-chip .badge{
      display:inline-block; min-width:18px; height:18px; line-height:18px;
      text-align:center; font-size:.8em; border-radius:9px; background:#eee; border:1px solid #bbb;
    }

    .assessment-table { width:100%; border-collapse:collapse; table-layout:fixed; }
    .assessment-table th{ text-align:left; padding:6px 8px; vertical-align:top; width:34%; }
    .assessment-table td{ padding:6px 8px; vertical-align:top; }
    .assessment-table input, .assessment-table textarea{
      width:100%; box-sizing:border-box; padding:8px 10px; font-size:1rem;
      border:1px solid #cfcfcf; border-radius:6px; background:#fff;
    }
    .assessment-table input{ min-height:36px; }
    .assessment-table textarea{ min-height:90px; resize:vertical; line-height:1.35; }

    .field-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:6px; }
    .pill{
      padding:4px 10px; border:1px solid #c9c9c9; border-radius:999px; background:#fff; cursor:pointer;
      font-size:.9em; display:inline-flex; align-items:center; gap:6px;
    }

    .btn{ background:#003087; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
    .btn:disabled{ background:#a9a9a9; cursor:not-allowed; }

    /* Related drawer */
    #relatedPane{
      flex: 0 0 auto;
      width: var(--related-width);
      max-width: 100vw;
      background:#fff; border-left:1px solid #e1e1e1;
      box-shadow: -10px 0 20px rgba(0,0,0,.06);
      display:none; padding:12px; box-sizing:border-box;
      overflow:auto;
    }
    .app--related-open #relatedPane{ display:block; }
    .app--related-wide #relatedPane{ width: var(--related-width-wide); }

    #relatedHead{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .tabs{ display:flex; gap:8px; margin:10px 0 12px; flex-wrap:wrap; }
    .tab{ padding:6px 10px; border:1px solid #c9c9c9; border-radius:999px; background:#f8f8f8; cursor:pointer; display:inline-flex; align-items:center; gap:6px; }
    .tab.active{ background:#fff; border-color:#888; }
    .list{ display:flex; flex-direction:column; gap:10px; }
    .card{ border:1px solid #eee; border-radius:8px; padding:10px; }
    .row{ display:flex; gap:10px; }
    .row > * { flex:1; }
    .small{ font-size:.92em; color:#333; }
    .muted{ color:#666; font-size:.9em; }

    /* Two-column aligned editor (layer vs notes) */
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid .col{ border:1px solid #eee; border-radius:8px; padding:10px; }
    .grid .col h4{ margin:0 0 8px; font-size:1em; color:#003087; }
    .field{ margin:8px 0; }
    .field label{ display:block; font-size:.9em; color:#333; margin-bottom:4px; }
    .field input, .field textarea, .field select{
      width:100%; box-sizing:border-box; padding:8px 10px; border:1px solid #cfcfcf; border-radius:6px;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="mapPane"><div id="viewDiv"></div></div>

    <div id="infoPane">
      <h2>Section 16 Assessment</h2>
      <p id="startHint">Select a parcel on the map or search a Lot/Plan to begin.</p>

      <div id="formFields" style="display:none;">
        <!-- Parcel Details -->
        <h3>Parcel Details</h3>
        <table class="assessment-table">
          <tr><th>Lot/Plan</th>                 <td><input id="lotplan"     disabled /></td></tr>
          <tr><th>Lot</th>                      <td><input id="lot"         disabled /></td></tr>
          <tr><th>Plan</th>                     <td><input id="plan"        disabled /></td></tr>
          <tr><th>Survey Indicator</th>         <td><input id="surv_ind"    disabled /></td></tr>
          <tr><th>Title Reference</th>          <td><input id="title_ref"             /></td></tr>
          <tr><th>Property Address</th>         <td><input id="prop_addr"             /></td></tr>
          <tr><th>Area (ha)</th>                <td><input id="lot_area_c"            /></td></tr>
          <tr><th>Tenure</th>                   <td><input id="tenure"       disabled /></td></tr>
          <tr><th>Registered Owner/Trustee</th> <td><input id="reg_owner"            /></td></tr>
          <tr><th>Local Government Area</th>    <td><input id="shire_name"   disabled /></td></tr>
        </table>

        <!-- Administrative Attributes -->
        <h3>Administrative Attributes</h3>
        <table class="assessment-table">
          <tr><th>Access (Legal)</th>       <td><input id="access_l"    /></td></tr>
          <tr><th>Access (Practical)</th>   <td><input id="access_p"    /></td></tr>
          <tr><th>Registered Interests</th> <td><input id="ciram_chk"   /></td></tr>
          <tr><th>Current Valuation</th>    <td><input id="qvas_val"    /></td></tr>
          <tr><th>eLVAS Cases</th>          <td><input id="elvas_ref"   /></td></tr>
        </table>

        <!-- Site History & Background -->
        <h3>
          Site History &amp; Background
          <span class="rel-chip" id="openNotes" title="View notes for this parcel">Notes <span class="badge" id="badgeNotes">0</span></span>
        </h3>
        <table class="assessment-table">
          <tr><th>Native Title Status</th>      <td><input id="nt_status"      /></td></tr>
          <tr><th>Indigenous Cult Heritage</th> <td><input id="ind_cul_he"     /></td></tr>
          <tr><th>Qld Cult Heritage</th>        <td><input id="qld_cul_he"     /></td></tr>
          <tr><th>Historical Tenure</th>        <td><input id="ten_hist"       /></td></tr>
        </table>

        <!-- Physical, Biological & Economic -->
        <h3>Physical, Biological &amp; Economic</h3>
        <table class="assessment-table">
          <tr><th>Parcel Type</th>     <td><input id="parcel_typ"  /></td></tr>
          <tr><th>Cover Type</th>      <td><input id="cover_typ"   /></td></tr>
          <tr>
            <th>Plan Constraints</th>
            <td>
              <textarea id="plan_const"></textarea>
              <div class="field-actions">
                <span class="pill" id="openAttach" title="View/Add attachments">Attachments <span class="badge" id="badgeAttach">0</span></span>
              </div>
            </td>
          </tr>
          <tr><th>MAUT Use</th>        <td><input id="mau"         /></td></tr>
          <tr><th>Past Material</th>   <td><input id="p_mat"       /></td></tr>
          <tr><th>Mining Interest</th> <td><input id="mine_int"    /></td></tr>
          <tr><th>EPM App/Grant</th>   <td><input id="epm_app" /><br/><input id="epm_granted" placeholder="Granted" /></td></tr>
          <tr><th>ML Permit App/Grant</th><td><input id="ml_permit_app" /><br/><input id="ml_granted" placeholder="Granted" /></td></tr>
          <tr><th>Exploration Permit</th> <td><input id="appln_int" /></td></tr>
        </table>

        <!-- Environment & Planning -->
        <h3>Environment &amp; Planning</h3>
        <table class="assessment-table">
          <tr><th>Contaminated Land</th>  <td><input id="contam_lan"     /></td></tr>
          <tr><th>Stock Route</th>        <td><input id="stk_route"      /></td></tr>
          <tr><th>State Plan Policy</th>  <td><input id="plan_schem"     /></td></tr>
          <tr><th>Regional Plan</th>      <td><textarea id="regional_plan"></textarea></td></tr>
          <tr><th>Flood Hazard</th>       <td><input id="flooding"       /></td></tr>
          <tr><th>Bushfire Hazard</th>    <td><input id="bushfire"       /></td></tr>
          <tr><th>Coastal Management</th> <td><input id="coastal_mgmt"   /></td></tr>
          <tr><th>Veg Mgmt Categories</th><td><input id="veg_mgmt_cat"   /></td></tr>
          <tr><th>Veg Mgmt Reg Ecos</th>  <td><input id="veg_mgmt_reg_eco"/></td></tr>
        </table>

        <!-- Social & Cultural -->
        <h3>Social &amp; Cultural Attributes</h3>
        <table class="assessment-table">
          <tr><th>Heritage Mgmt Plan</th><td><textarea id="cul_mgmt_plan"></textarea></td></tr>
          <tr><th>Study Area Bdy</th>    <td><textarea id="cul_studyarea_bdy"></textarea></td></tr>
          <tr><th>Party</th>             <td><input id="cul_party" /></td></tr>
        </table>

        <div style="margin-top:12px; text-align:right;">
          <button id="saveBtn" class="btn" disabled>Save</button>
          <button id="reportBtn" class="btn" disabled>Report</button>
        </div>
      </div>
    </div>

    <!-- Related Drawer -->
    <div id="relatedPane">
      <div id="relatedHead">
        <strong>Related</strong>
        <div class="row" style="gap:6px;">
          <button id="toggleWide" class="btn" style="background:#28559a">Wide</button>
          <button id="closeRelated" class="btn" style="background:#666">Close</button>
        </div>
      </div>
      <div class="tabs">
        <div class="tab active" data-tab="notes">Notes <span class="badge" id="tabBadgeNotes">0</span></div>
        <div class="tab" data-tab="attach">Attachments <span class="badge" id="tabBadgeAttach">0</span></div>
      </div>
      <div id="relatedActions" class="row" style="margin-bottom:10px;"></div>
      <div id="relatedContent" class="list"></div>
    </div>
  </div>

  <script src="https://js.arcgis.com/4.29/"></script>
  <script>
  require([
    "esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/layers/GraphicsLayer",
    "esri/Graphic","esri/widgets/Zoom","esri/widgets/Search"
  ], function(Map, MapView, FeatureLayer, GraphicsLayer, Graphic, Zoom, Search) {

    // --- UAT service ---
    const BASE = "https://uat-qportal.information.qld.gov.au/arcgis/rest/services/LEAP_ClaimParcels_rbt/FeatureServer";
    const CLAIM_URL  = BASE + "/0"; // parcels
    const NOTES_URL  = BASE + "/1"; // LEAP_S16_AssmtNotes_rbt
    const ATTACH_URL = BASE + "/2"; // LEAP_S16_Attachments

    // Map + view
    const map = new Map({ basemap: "satellite" });
    const view = new MapView({ container: "viewDiv", map, zoom: 6, center: [145, -24] });
    view.popup.autoOpenEnabled = false;

    // Layers
    const claimLayer  = new FeatureLayer({ url: CLAIM_URL,  outFields:["*"] });
    const notesTable  = new FeatureLayer({ url: NOTES_URL,  outFields:["*"] });
    const attachTable = new FeatureLayer({ url: ATTACH_URL, outFields:["*"] });

    const highlightLayer = new GraphicsLayer();
    map.addMany([claimLayer, highlightLayer]);

    // Make sure map always reflows when side panes change
    const resizeView = () => view && view.resize();

    // Zoom widget
    view.when(() => {
      view.ui.remove("zoom");
      view.ui.add(new Zoom({ view }), "top-left");
    });

    // Search on map top-right (Lot/Plan)
    const searchWidget = new Search({
      view, allPlaceholder: "Search Lot/Plan e.g. 45SP164230",
      includeDefaultSources: false,
      sources: [{
        layer: claimLayer, searchFields:["lotplan"], displayField:"lotplan",
        exactMatch:false, outFields:["*"], name:"Claim Parcels", placeholder:"e.g. 45SP164230"
      }]
    });
    view.ui.add(searchWidget, "top-right");

    // DOM
    const startHint  = document.getElementById("startHint");
    const formFields = document.getElementById("formFields");
    const saveBtn    = document.getElementById("saveBtn");
    const reportBtn  = document.getElementById("reportBtn");
    const openNotes  = document.getElementById("openNotes");
    const openAttach = document.getElementById("openAttach");
    const closeRelated = document.getElementById("closeRelated");
    const toggleWide = document.getElementById("toggleWide");

    const badgeNotes = document.getElementById("badgeNotes");
    const badgeAttach= document.getElementById("badgeAttach");
    const tabBadgeNotes = document.getElementById("tabBadgeNotes");
    const tabBadgeAttach= document.getElementById("tabBadgeAttach");
    const relatedContent = document.getElementById("relatedContent");
    const relatedActions = document.getElementById("relatedActions");

    document.querySelectorAll(".tab").forEach(t=>{
      t.addEventListener("click", ()=> {
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        renderRelated();
      });
    });
    closeRelated.addEventListener("click", ()=> {
      document.body.classList.remove("app--related-open","app--related-wide");
      resizeView();
    });
    toggleWide.addEventListener("click", ()=> {
      document.body.classList.toggle("app--related-wide");
      toggleWide.textContent = document.body.classList.contains("app--related-wide") ? "Collapse" : "Wide";
      resizeView();
    });
    openNotes .addEventListener("click", ()=> { openRelated("notes", true); });
    openAttach.addEventListener("click", ()=> { openRelated("attach", true); });

    function openRelated(which, wide=false){
      document.body.classList.add("app--related-open");
      document.body.classList.toggle("app--related-wide", !!wide); // open wide by default
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      document.querySelector(`.tab[data-tab="${which}"]`).classList.add("active");
      renderRelated().then(resizeView);
    }

    // State
    let selectedFeature = null;
    let parcelFieldMap = {}; // {name: {alias,type}}
    let notesFieldMap  = {};
    let attachDomain = []; // coded values for attach_category

    Promise.all([claimLayer.load(), notesTable.load(), attachTable.load()]).then(()=>{
      // cache field metadata
      claimLayer.fields.forEach(f => parcelFieldMap[f.name] = {alias:f.alias||f.name, type:f.type});
      notesTable.fields.forEach(f => notesFieldMap[f.name]  = {alias:f.alias||f.name, type:f.type});
      // coded domain for attachments
      const f = attachTable.fields.find(f => f.name.toLowerCase()==="attach_category");
      if (f && f.domain && f.domain.codedValues) {
        attachDomain = f.domain.codedValues.map(cv => ({ code: cv.code, name: cv.name }));
      }
    });

    // Init
    claimLayer.when(() => view.goTo(claimLayer.fullExtent).catch(()=>{}));
    searchWidget.on("select-result", (evt) => { if (evt.result.feature) onSelectFeature(evt.result.feature); });
    view.on("click", (evt) => {
      view.hitTest(evt).then((r) => {
        const hit = r.results.find(x => x.graphic && x.graphic.layer === claimLayer);
        if (hit) onSelectFeature(hit.graphic); else clearSelection();
      });
    });
    clearSelection();

    function setAppSelected(on){ document.body.classList.toggle("app--parcel-selected", !!on); }
    function clearSelection(){
      highlightLayer.removeAll();
      selectedFeature = null;
      startHint.style.display  = "block";
      formFields.style.display = "none";
      saveBtn.disabled = reportBtn.disabled = true;
      setAppSelected(false);
      updateRelatedBadges(0,0);
      relatedContent.innerHTML = "";
      relatedActions.innerHTML = "";
    }

    function onSelectFeature(feature){
      selectedFeature = feature;
      fillForm(feature);
      highlight(feature);
      setAppSelected(true);
      startHint.style.display  = "none";
      formFields.style.display = "block";
      saveBtn.disabled = reportBtn.disabled = false;
      refreshRelatedCounts().catch(console.warn);
      if (document.body.classList.contains("app--related-open")) renderRelated().then(resizeView);
    }

    function fillForm(feature){
      const attrs = feature.attributes || {};
      for (const [k,v0] of Object.entries(attrs)){
        const el = document.getElementById(k);
        if (!el) continue;
        let v = v0;
        if (k === "lot_area" && v != null) v = (v/10000).toFixed(3);
        el.value = (v == null ? "" : v);
      }
    }

    function highlight(feature){
      highlightLayer.removeAll();
      highlightLayer.add(new Graphic({
        geometry: feature.geometry,
        symbol: { type:"simple-fill", color:[0,200,0,0.25], outline:{ color:"#00e0ff", width:2 } }
      }));
      const padded = feature.geometry.extent.expand(1.2);
      view.goTo(padded).catch(()=>{});
    }

    // Save edits (parcels)
    saveBtn.addEventListener("click", () => {
      if (!selectedFeature) return;
      const upd = { ...selectedFeature.attributes };
      Object.keys(upd).forEach(k => {
        const el = document.getElementById(k);
        if (el && !el.disabled) upd[k] = el.value;
      });
      claimLayer.applyEdits({ updateFeatures: [{ attributes: upd }]})
        .then(()=> alert("Saved"))
        .catch(e => alert("Save error: " + e.message));
    });

    // --- Related data (counts + editors) ---

    async function refreshRelatedCounts(){
      if (!selectedFeature) { updateRelatedBadges(0,0); return; }
      const gid = selectedFeature.attributes["globalid"];
      if (!gid) { updateRelatedBadges(0,0); return; }

      let notesCount = 0;
      try { notesCount = await notesTable.queryFeatureCount({ where: `parcelguid='${gid}'` }); } catch{}

      let attachCount = 0;
      if (notesCount > 0){
        try {
          const notes = await notesTable.queryFeatures({
            where:`parcelguid='${gid}'`, outFields:["globalid"], returnGeometry:false
          });
          const gids = (notes.features||[]).map(f => `'${f.attributes.globalid}'`);
          if (gids.length){
            attachCount = await attachTable.queryFeatureCount({ where:`parent_guid IN (${gids.join(",")})` });
          }
        } catch{}
      }
      updateRelatedBadges(notesCount, attachCount);
    }
    function updateRelatedBadges(n,a){
      badgeNotes.textContent = n; tabBadgeNotes.textContent = n;
      badgeAttach.textContent = a; tabBadgeAttach.textContent = a;
    }
    function currentTab(){
      const active = document.querySelector(".tab.active");
      return active ? active.getAttribute("data-tab") : "notes";
    }
    function setRelatedActions(which){
      relatedActions.innerHTML = "";
      if (!selectedFeature) return;
      if (which === "notes"){
        const add = document.createElement("button");
        add.className = "btn"; add.textContent = "New Note";
        add.onclick = createNoteForParcel;
        relatedActions.appendChild(add);
      } else {
        const add = document.createElement("button");
        add.className = "btn"; add.textContent = "New Attachment";
        add.onclick = createAttachmentForFirstNote;
        relatedActions.appendChild(add);
      }
    }

    async function renderRelated(){
      if (!selectedFeature){ relatedContent.innerHTML = ""; return; }
      const which = currentTab();
      setRelatedActions(which);
      relatedContent.innerHTML = "";

      const parcel = selectedFeature.attributes;
      const parcelGID = parcel["globalid"];
      if (!parcelGID) { relatedContent.innerHTML = "<div class='card'>Missing parcel globalid.</div>"; return; }

      if (which === "notes"){
        // one or many notes — show aligned editor for the first (most common)
        const res = await notesTable.queryFeatures({
          where:`parcelguid='${parcelGID}'`,
          outFields:["*"], returnGeometry:false, orderByFields:["created_date ASC"]
        });
        const rows = res.features || [];
        if (!rows.length){
          relatedContent.innerHTML = "<div class='card'>No notes yet for this parcel.</div>";
          return;
        }
        const note = rows[0]; // edit the first row; (we can add a selector later)
        const at = note.attributes;

        // Build aligned editor: left (parcel), right (note). We try to pair fields intelligently.
        const pairs = buildFieldPairs(parcel, at);

        const wrapper = document.createElement("div");
        wrapper.className = "grid";
        // left
        const left = document.createElement("div");
        left.className = "col";
        left.innerHTML = "<h4>Parcel (read-only)</h4>";
        pairs.forEach(p=>{
          const div = document.createElement("div");
          div.className = "field";
          div.innerHTML = `<label>${escapeHtml(p.aliasParcel)}</label><div class="muted">${escapeHtml(p.parcelValue ?? "")}</div>`;
          left.appendChild(div);
        });
        // right (note editor)
        const right = document.createElement("div");
        right.className = "col";
        right.innerHTML = "<h4>Note (editable)</h4>";
        pairs.forEach(p=>{
          const div = document.createElement("div");
          div.className = "field";
          const val = (p.noteValue ?? "");
          if (p.long){
            div.innerHTML = `<label>${escapeHtml(p.aliasNote)}</label><textarea data-field="${p.noteField}">${escapeHtml(val)}</textarea>`;
          } else {
            div.innerHTML = `<label>${escapeHtml(p.aliasNote)}</label><input data-field="${p.noteField}" value="${escapeHtml(val)}" />`;
          }
          right.appendChild(div);
        });

        const actions = document.createElement("div");
        actions.style = "margin-top:10px; text-align:right;";
        const save = document.createElement("button");
        save.className = "btn"; save.textContent = "Save Note";
        save.onclick = async ()=>{
          const edits = {...note.attributes};
          right.querySelectorAll("[data-field]").forEach(el=>{
            const f = el.getAttribute("data-field");
            edits[f] = el.tagName==="TEXTAREA" ? el.value : el.value;
          });
          try{
            const r = await notesTable.applyEdits({ updateFeatures:[{ attributes: edits }] });
            if (r.updateFeatureResults?.[0]?.objectId) alert("Note saved");
            else alert("Save failed");
            refreshRelatedCounts();
          }catch(e){ alert("Save error: "+e.message); }
        };
        actions.appendChild(save);

        wrapper.appendChild(left);
        wrapper.appendChild(right);
        relatedContent.appendChild(wrapper);
        relatedContent.appendChild(actions);

        // Also list any extra note rows below
        if (rows.length > 1){
          const list = document.createElement("div");
          list.className = "list";
          rows.slice(1).forEach((r,i)=>{
            const d = document.createElement("div");
            d.className="card small";
            d.innerHTML = `<strong>Note ${i+2}</strong><pre style="white-space:pre-wrap; margin:8px 0 0 0;">${escapeHtml(JSON.stringify(r.attributes,null,2))}</pre>`;
            list.appendChild(d);
          });
          relatedContent.appendChild(list);
        }

      } else {
        // ATTACHMENTS
        const notes = await notesTable.queryFeatures({
          where:`parcelguid='${parcelGID}'`, outFields:["globalid","s16_lotplan"], returnGeometry:false
        });
        const gids = (notes.features||[]).map(f => `'${f.attributes.globalid}'`);
        if (!gids.length){
          relatedContent.innerHTML = "<div class='card'>No notes yet; add a Note first, then attach.</div>";
          return;
        }
        const where = `parent_guid IN (${gids.join(",")})`;
        const res = await attachTable.queryFeatures({
          where, outFields:["*"], returnGeometry:false, orderByFields:["created_date ASC"]
        });
        const rows = res.features || [];
        if (!rows.length){
          relatedContent.innerHTML = "<div class='card'>No attachments yet for this parcel.</div>";
          return;
        }
        rows.forEach((r, i) => {
          const at = r.attributes;
          const div = document.createElement("div");
          div.className = "card small";
          const dd = buildAttachEditor(at);
          div.appendChild(dd);
          const actions = document.createElement("div");
          actions.style = "margin-top:8px; text-align:right;";
          const save = document.createElement("button"); save.className="btn"; save.textContent="Save";
          save.onclick = async ()=>{
            const edits = {...r.attributes};
            const nameEl = dd.querySelector('[data-field="attach_name"]');
            const catEl  = dd.querySelector('[data-field="attach_category"]');
            if (nameEl) edits.attach_name = nameEl.value;
            if (catEl)  edits.attach_category = catEl.value;
            try{
              const rr = await attachTable.applyEdits({ updateFeatures:[{ attributes: edits }] });
              if (rr.updateFeatureResults?.[0]?.objectId) alert("Attachment updated");
              else alert("Update failed");
              refreshRelatedCounts();
            }catch(e){ alert("Update error: "+e.message); }
          };
          actions.appendChild(save);
          div.appendChild(actions);
          relatedContent.appendChild(div);
        });
      }
    }

    function buildAttachEditor(at){
      const wrap = document.createElement("div");
      // Name
      const f1 = document.createElement("div"); f1.className="field";
      f1.innerHTML = `<label>Attachment name</label><input data-field="attach_name" value="${escapeHtml(at.attach_name ?? "")}" />`;
      wrap.appendChild(f1);
      // Category (coded)
      const f2 = document.createElement("div"); f2.className="field";
      let opts = attachDomain.map(cv => `<option value="${escapeHtml(cv.code)}"${cv.code===at.attach_category?" selected":""}>${escapeHtml(cv.name)}</option>`).join("");
      if (!opts) opts = `<option value="${escapeHtml(at.attach_category ?? "")}" selected>${escapeHtml(at.attach_category ?? "")}</option>`;
      f2.innerHTML = `<label>Category</label><select data-field="attach_category">${opts}</select>`;
      wrap.appendChild(f2);
      // Parent GUID (read-only)
      const f3 = document.createElement("div"); f3.className="field";
      f3.innerHTML = `<label>Parent Note GUID</label><div class="muted">${escapeHtml(at.parent_guid ?? "")}</div>`;
      wrap.appendChild(f3);
      return wrap;
    }

    // Build best-effort aligned pairs (parcel vs note)
    function buildFieldPairs(parcelAttrs, noteAttrs){
      const pairs = [];
      const add = (pField, nField)=>{
        const pMeta = parcelFieldMap[pField] || {alias:pField};
        const nMeta = notesFieldMap[nField]  || {alias:nField};
        const val = parcelAttrs[pField];
        const nval= noteAttrs[nField];
        const long = /notes?|desc|plan|summary|comment|constraint/i.test(nField);
        pairs.push({
          parcelField:pField, noteField:nField,
          aliasParcel:pMeta.alias, aliasNote:nMeta.alias,
          parcelValue: val, noteValue: nval, long
        });
      };
      // 1) Direct matches
      Object.keys(noteAttrs).forEach(nf=>{
        if (nf.match(/^(objectid|globalid|parcelguid|created_|last_edited)/i)) return;
        if (parcelAttrs.hasOwnProperty(nf)) add(nf, nf);
      });
      // 2) notes/description pairs e.g., regional_plan <-> regional_plan_notes
      Object.keys(noteAttrs).forEach(nf=>{
        if (pairs.find(p=>p.noteField===nf)) return;
        const base = nf.replace(/_?notes?$/i,"");
        if (base && parcelAttrs.hasOwnProperty(base)) add(base, nf);
      });
      // 3) Always include lotplan at top if present
      if (!pairs.find(p=>p.parcelField==="lotplan") && noteAttrs.hasOwnProperty("s16_lotplan")){
        pairs.unshift({
          parcelField:"lotplan", noteField:"s16_lotplan",
          aliasParcel:(parcelFieldMap["lotplan"]?.alias)||"Lot/Plan",
          aliasNote:(notesFieldMap["s16_lotplan"]?.alias)||"Lot/Plan (Note)",
          parcelValue: parcelAttrs["lotplan"], noteValue: noteAttrs["s16_lotplan"], long:false
        });
      }
      // Fallback: if none matched, show a couple of useful ones
      if (!pairs.length){
        ["plan_schem","regional_plan","qld_cul_he","nt_status"].forEach(key=>{
          if (parcelAttrs.hasOwnProperty(key) || noteAttrs.hasOwnProperty(key)){
            add(key, key in noteAttrs ? key : (key+"_notes"));
          }
        });
      }
      return pairs;
    }

    // Create a new Note linked to this parcel
    async function createNoteForParcel(){
      if (!selectedFeature) return;
      const parcelGID = selectedFeature.attributes["globalid"];
      const lotplan   = selectedFeature.attributes["lotplan"] || "";
      const attrs = { parcelguid: parcelGID, s16_lotplan: lotplan };
      try{
        const res = await notesTable.applyEdits({ addFeatures: [{ attributes: attrs }] });
        if (res.addFeatureResults?.[0]?.objectId){
          alert("New note added.");
          await renderRelated();
          refreshRelatedCounts();
        } else {
          alert("Create failed");
        }
      }catch(e){ alert("Error creating note: " + e.message); }
    }

    // Create a new Attachment linked to the first note
    async function createAttachmentForFirstNote(){
      if (!selectedFeature) return;
      const parcelGID = selectedFeature.attributes["globalid"];
      const notes = await notesTable.queryFeatures({
        where:`parcelguid='${parcelGID}'`,
        outFields:["globalid"], returnGeometry:false, orderByFields:["created_date ASC"]
      });
      if (!notes.features?.length){
        alert("No notes found. Create a Note first.");
        return;
      }
      const noteGID = notes.features[0].attributes.globalid;
      const name = prompt("Attachment name?");
      if (name == null) return;

      let cat = (attachDomain[0]?.code) || "";
      if (attachDomain.length){
        const list = attachDomain.map(cv => `${cv.code} — ${cv.name}`).join("\n");
        const inp = prompt("Attachment category code?\n\n" + list + "\n\nEnter code exactly:");
        if (inp != null && attachDomain.some(cv => cv.code === inp)) cat = inp;
      }
      const attrs = { parent_guid: noteGID, attach_name: name, attach_category: cat };
      try{
        const res = await attachTable.applyEdits({ addFeatures: [{ attributes: attrs }] });
        if (res.addFeatureResults?.[0]?.objectId){
          alert("Attachment (metadata) added.");
          await renderRelated();
          refreshRelatedCounts();
        } else {
          alert("Add failed");
        }
      }catch(e){ alert("Error adding attachment: " + e.message); }
    }

    // Ensure view resizes when panes open/close
    const ro = new ResizeObserver(()=> resizeView());
    ro.observe(document.getElementById("infoPane"));
    ro.observe(document.getElementById("relatedPane"));
  });
  </script>
</body>
</html>
