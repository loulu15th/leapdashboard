<script src="https://js.arcgis.com/4.29/"></script>
<script>
require([
  "esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/layers/GraphicsLayer",
  "esri/Graphic","esri/widgets/Zoom","esri/widgets/Search"
], function(Map, MapView, FeatureLayer, GraphicsLayer, Graphic, Zoom, Search) {

  // ----------------- Config -----------------
  const BASE = "https://uat-qportal.information.qld.gov.au/arcgis/rest/services/LEAP_ClaimParcels_rbt/FeatureServer";
  const PARCEL_URL = BASE + "/0";

  // ----------------- DOM -----------------
  const svcWarn   = document.getElementById("svcWarn");
  const startHint = document.getElementById("startHint");
  const form      = document.getElementById("formFields");
  const saveBtn   = document.getElementById("saveBtn");
  const reportBtn = document.getElementById("reportBtn");
  const openNotes = document.getElementById("openNotes");
  const openAttach= document.getElementById("openAttach");
  const closeRelated = document.getElementById("closeRelated");
  const toggleWide   = document.getElementById("toggleWide");
  const tabsEl    = document.getElementById("tabs");
  const relatedContent = document.getElementById("relatedContent");
  const relatedActions = document.getElementById("relatedActions");
  const badgeNotes  = document.getElementById("badgeNotes");
  const badgeAttach = document.getElementById("badgeAttach");

  const NOTE_FIELDS = [
    "plan_schem","regional_plan","qld_cul_he","nt_status","ten_hist",
    "plan_const","cul_mgmt_plan","cul_studyarea_bdy"
  ];

  // ----------------- Map FIRST (always) -----------------
  const map = new Map({ basemap: "satellite" });
  const view = new MapView({ container: "viewDiv", map, zoom: 6, center: [145, -24] });
  view.popup.autoOpenEnabled = false;
  const resizeView = ()=> view && view.resize();

  view.when(()=>{
    view.ui.remove("zoom");
    view.ui.add(new Zoom({ view }), "top-left");
  });

  // add Search immediately; add Lot/Plan source after parcel layer loads
  const search = new Search({ view, includeDefaultSources: true, allPlaceholder: "Search address or Lot/Plan" });
  view.ui.add(search, "top-right");

  const highlightLayer = new GraphicsLayer();
  map.add(highlightLayer);

  // ----------------- Try to load service (safe) -----------------
  let parcelFL = null, relRegistry = {}, parcelFields = {}, activeTab = null, selected = null, noteScopeField = null, attachDomain = [];

  (async function init(){
    parcelFL = await safeLoadFL(PARCEL_URL);
    if (!parcelFL){
      // keep the map working; show banner
      if (svcWarn) svcWarn.style.display = "block";
      return;
    }
    if (svcWarn) svcWarn.style.display = "none";
    map.add(parcelFL);
    parcelFields = indexFields(parcelFL.fields);
    try{ await view.goTo(parcelFL.fullExtent); }catch{}

    // Lot/Plan as a Search source
    search.sources.add({
      layer: parcelFL,
      searchFields:["lotplan"],
      displayField:"lotplan",
      name:"Claim Parcels",
      placeholder:"e.g. 45SP164230",
      outFields:["*"]
    });

    // Build related tabs dynamically
    await buildRelatedRegistry();

    // interactions
    view.on("click", hitSelect);
    search.on("select-result", (e)=> e.result?.feature && onSelect(e.result.feature));

    // add the tiny ðŸ“ buttons
    installFieldNoteButtons();
  })();

  async function safeLoadFL(url){
    const fl = new FeatureLayer({ url, outFields:["*"] });
    try{ await fl.load(); return fl; }
    catch(e){ console.warn("Failed to load:", url, e); return null; }
  }
  function indexFields(fields){ const m={}; fields.forEach(f=> m[f.name]={alias:f.alias||f.name,type:f.type}); return m; }

  async function buildRelatedRegistry(){
    relRegistry = {};
    const rels = parcelFL.relationships || [];
    for (const rel of rels){
      const url = BASE + "/" + rel.relatedTableId;
      const tbl = await safeLoadFL(url);
      if (!tbl) continue;
      const title = (tbl.title || tbl.name || `Related ${rel.id}`).trim();
      const low = title.toLowerCase();
      const key = low.includes("attach") ? "attachments" : low.includes("note") ? "notes" : `rel_${rel.id}`;
      relRegistry[key] = { layer: tbl, rel, label: title, badgeEl: null };
      if (key === "attachments"){
        const f = tbl.fields.find(f=> f.name.toLowerCase()==="attach_category");
        if (f?.domain?.codedValues) attachDomain = f.domain.codedValues.map(cv=>({code:cv.code,name:cv.name}));
      }
    }
    buildTabs();
  }

  function buildTabs(){
    tabsEl.innerHTML = "";
    const keys = Object.keys(relRegistry);
    if (!keys.length){
      const t=document.createElement("div");
      t.className="tab active"; t.textContent="No Related Tables";
      tabsEl.appendChild(t); return;
    }
    keys.forEach(k=>{
      const v=relRegistry[k];
      const t=document.createElement("div");
      t.className="tab";
      t.innerHTML = `${htmlEscape(v.label)} <span class="badge">0</span>`;
      t.onclick = ()=> setActiveTab(k);
      tabsEl.appendChild(t);
      v.badgeEl = t.querySelector(".badge");
    });
    setActiveTab(relRegistry.notes ? "notes" : keys[0]);
  }
  function setActiveTab(key){
    activeTab = key;
    [...tabsEl.children].forEach(el => el.classList.toggle("active", el.textContent.startsWith(relRegistry[key]?.label)));
    renderRelated();
  }

  // drawer controls
  (openNotes||{}).onclick  = ()=> { noteScopeField=null; openDrawer("notes"); };
  (openAttach||{}).onclick = ()=> openDrawer("attachments");
  (closeRelated||{}).onclick = ()=> { document.body.classList.remove("app--related-open","app--related-wide"); noteScopeField=null; resizeView(); };
  (toggleWide||{}).onclick   = ()=> { document.body.classList.toggle("app--related-wide"); toggleWide.textContent = document.body.classList.contains("app--related-wide") ? "Collapse" : "Wide"; resizeView(); };
  function openDrawer(key){ if (!relRegistry[key]) return; setActiveTab(key); document.body.classList.add("app--related-open","app--related-wide"); renderRelated().then(resizeView); }

  // selection
  function hitSelect(evt){
    if (!parcelFL) return;
    view.hitTest(evt).then(r=>{
      const hit = r.results.find(x => x.graphic?.layer === parcelFL);
      if (hit) onSelect(hit.graphic); else clearSelection();
    });
  }
  function onSelect(f){
    selected = f;
    fillForm(f);
    highlight(f);
    document.body.classList.add("app--parcel-selected");
    startHint.style.display="none"; form.style.display="block";
    saveBtn.disabled = reportBtn.disabled = false;
    refreshCounts();
    if (document.body.classList.contains("app--related-open")) renderRelated().then(resizeView);
  }
  function clearSelection(){
    highlightLayer.removeAll();
    selected = null;
    startHint.style.display="block"; form.style.display="none";
    saveBtn.disabled = reportBtn.disabled = true;
    document.body.classList.remove("app--parcel-selected");
    relatedActions.innerHTML = ""; relatedContent.innerHTML = "";
    Object.values(relRegistry).forEach(v=> v.badgeEl && (v.badgeEl.textContent="0"));
  }
  function fillForm(f){
    const a=f.attributes||{};
    Object.entries(a).forEach(([k,v])=>{
      const el=document.getElementById(k); if (!el) return;
      el.value = (v==null ? "" : (k==="lot_area" ? (v/10000).toFixed(3) : v));
    });
  }
  function highlight(f){
    highlightLayer.removeAll();
    highlightLayer.add(new Graphic({ geometry:f.geometry, symbol:{ type:"simple-fill", color:[0,200,0,0.25], outline:{ color:"#00e0ff", width:2 } }}));
    try{ view.goTo(f.geometry.extent.expand(1.2)); }catch{}
  }

  // save parcel edits
  saveBtn.onclick = ()=>{
    if (!selected || !parcelFL) return;
    const attrs = {...selected.attributes};
    Object.keys(attrs).forEach(k=>{ const el=document.getElementById(k); if (el && !el.disabled) attrs[k]=el.value; });
    parcelFL.applyEdits({ updateFeatures:[{ attributes: attrs }] })
      .then(()=> alert("Saved"))
      .catch(e=> alert("Save error: "+e.message));
  };

  // counts
  async function refreshCounts(){
    if (!selected) return;
    const p = selected.attributes;
    for (const [k,v] of Object.entries(relRegistry)){
      let count=0;
      try{
        if (k==="attachments" && relRegistry.notes){
          const n = await relRegistry.notes.layer.queryFeatures({
            where: `${relRegistry.notes.rel.relatedKeyField} = '${p[relRegistry.notes.rel.keyField]}'`,
            outFields:["globalid"], returnGeometry:false
          });
          const gids=(n.features||[]).map(f=> `'${f.attributes.globalid}'`);
          count = gids.length ? await v.layer.queryFeatureCount({ where:`parent_guid IN (${gids.join(",")})` }) : 0;
        } else {
          count = await v.layer.queryFeatureCount({ where:`${v.rel.relatedKeyField} = '${p[v.rel.keyField]}'` });
        }
      }catch{}
      if (v.badgeEl) v.badgeEl.textContent = count;
      if (k==="notes") badgeNotes.textContent = count;
      if (k==="attachments") badgeAttach.textContent = count;
    }
  }

  // render
  async function renderRelated(){
    relatedActions.innerHTML=""; relatedContent.innerHTML="";
    if (!selected || !activeTab || !relRegistry[activeTab]) return;
    const {layer:tbl, rel, label} = relRegistry[activeTab];
    const parentVal = selected.attributes[rel.keyField];

    if (activeTab==="notes") return renderNotes(tbl, rel, parentVal);
    if (activeTab==="attachments") return renderAttachments(tbl, rel, parentVal);

    const res = await tbl.queryFeatures({
      where:`${rel.relatedKeyField}='${parentVal}'`,
      outFields:["*"], returnGeometry:false, orderByFields:["created_date ASC"]
    });
    const rows = res.features||[];
    relatedContent.innerHTML = rows.length ? "" : `<div class="card">No rows in <b>${htmlEscape(label)}</b> for this parcel.</div>`;
    rows.forEach((r,i)=>{
      const d=document.createElement("div"); d.className="card small";
      d.innerHTML = `<strong>${htmlEscape(label)} ${i+1}</strong><pre style="white-space:pre-wrap; margin:8px 0 0 0;">${htmlEscape(JSON.stringify(r.attributes,null,2))}</pre>`;
      relatedContent.appendChild(d);
    });
  }

  async function renderNotes(tbl, rel, parentVal){
    const res = await tbl.queryFeatures({
      where:`${rel.relatedKeyField}='${parentVal}'`,
      outFields:["*"], returnGeometry:false, orderByFields:["created_date ASC"]
    });
    const rows = res.features||[];
    if (!rows.length){
      relatedContent.innerHTML = "<div class='card'>No notes yet for this parcel.</div>";
      relatedActions.innerHTML = `<button class="btn" id="addNote">New Note</button>`;
      document.getElementById("addNote").onclick = createNote;
      return;
    }
    const note = rows[0], nAttrs = note.attributes, pAttrs = selected.attributes;
    const pairs = buildPairs(pAttrs, nAttrs, noteScopeField);

    const wrap=document.createElement("div"); wrap.className="grid";
    const left=document.createElement("div"); left.className="col"; left.innerHTML="<h4>Parcel (read-only)</h4>";
    pairs.forEach(p=>{
      const d=document.createElement("div");
      d.innerHTML=`<label>${htmlEscape(p.aliasP)}</label><div class="muted">${htmlEscape(p.pVal??"")}</div>`;
      left.appendChild(d);
    });
    const right=document.createElement("div"); right.className="col"; right.innerHTML="<h4>Note (editable)</h4>";
    pairs.forEach(p=>{
      const d=document.createElement("div");
      d.innerHTML = p.long
        ? `<label>${htmlEscape(p.aliasN)}</label><textarea data-field="${p.nField}">${htmlEscape(p.nVal??"")}</textarea>`
        : `<label>${htmlEscape(p.aliasN)}</label><input data-field="${p.nField}" value="${htmlEscape(p.nVal??"")}" />`;
      right.appendChild(d);
    });
    const actions=document.createElement("div"); actions.style="margin-top:10px; text-align:right;";
    const save=document.createElement("button"); save.className="btn"; save.textContent="Save Note";
    save.onclick = async ()=>{
      const edits={...nAttrs};
      right.querySelectorAll("[data-field]").forEach(el=> edits[el.getAttribute("data-field")] = el.value);
      try{ await tbl.applyEdits({ updateFeatures:[{ attributes: edits }] }); alert("Note saved"); refreshCounts(); }
      catch(e){ alert("Save error: "+e.message); }
    };
    actions.appendChild(save);
    wrap.appendChild(left); wrap.appendChild(right);
    relatedContent.appendChild(wrap); relatedContent.appendChild(actions);

    // ---- History (FIXED: no nested backticks) ----
    const hist=document.createElement("div"); hist.className="list";
    const histTitle=document.createElement("div"); histTitle.className="card";
    const fieldsForHistory = scopeToNoteFields(noteScopeField, tbl);
    histTitle.innerHTML = `<strong>History${
      noteScopeField ? ' â€” ' + htmlEscape(parcelFields[noteScopeField]?.alias || noteScopeField) : ''
    }</strong>`;
    hist.appendChild(histTitle);

    rows.forEach((r,i)=>{
      const a=r.attributes; let body="";
      fieldsForHistory.forEach(fn=>{ if (fn in a) body += `<div><b>${htmlEscape(fn)}:</b> ${htmlEscape(a[fn]??"")}</div>`; });
      if (!body) return;
      const c=document.createElement("div"); c.className="card small";
      c.innerHTML = `<div class="muted">Row ${i+1}</div>${body}`;
      hist.appendChild(c);
    });
    relatedContent.appendChild(hist);

    relatedActions.innerHTML = `<button class="btn" id="addNote2">New Note</button>`;
    document.getElementById("addNote2").onclick = createNote;

    function createNote(){
      const attrs = { parcelguid: pAttrs.globalid, s16_lotplan: pAttrs.lotplan||"" };
      tbl.applyEdits({ addFeatures:[{ attributes: attrs }] })
        .then(()=> renderRelated().then(refreshCounts))
        .catch(e=> alert("Create note error: "+e.message));
    }
  }

  async function renderAttachments(tbl, rel, parentVal){
    const nRel = relRegistry.notes; if (!nRel){ relatedContent.innerHTML="<div class='card'>Notes table not found.</div>"; return; }
    const ns = await nRel.layer.queryFeatures({
      where:`${nRel.rel.relatedKeyField}='${parentVal}'`,
      outFields:["globalid"], returnGeometry:false
    });
    const gids=(ns.features||[]).map(f=> `'${f.attributes.globalid}'`);
    if (!gids.length){ relatedContent.innerHTML="<div class='card'>No notes yet; add a Note first.</div>"; return; }
    const res = await tbl.queryFeatures({
      where:`parent_guid IN (${gids.join(",")})`,
      outFields:["*"], returnGeometry:false, orderByFields:["created_date ASC"]
    });
    const rows = res.features||[];
    if (!rows.length){ relatedContent.innerHTML="<div class='card'>No attachments yet.</div>"; }
    rows.forEach((r)=>{
      const a=r.attributes;
      const card=document.createElement("div"); card.className="card small";
      const f1=document.createElement("div"); f1.innerHTML=`<label>Attachment name</label><input data-field="attach_name" value="${htmlEscape(a.attach_name??"")}" />`;
      const f2=document.createElement("div");
      let opts = attachDomain.map(cv=>`<option value="${htmlEscape(cv.code)}"${cv.code===a.attach_category?" selected":""}>${htmlEscape(cv.name)}</option>`).join("");
      if (!opts) opts = `<option value="${htmlEscape(a.attach_category??"")}" selected>${htmlEscape(a.attach_category??"")}</option>`;
      f2.innerHTML = `<label>Category</label><select data-field="attach_category">${opts}</select>`;
      const f3=document.createElement("div"); f3.innerHTML=`<label>Parent Note GUID</label><div class="muted">${htmlEscape(a.parent_guid??"")}</div>`;
      const actions=document.createElement("div"); actions.style="margin-top:8px; text-align:right;";
      const save=document.createElement("button"); save.className="btn"; save.textContent="Save";
      save.onclick = ()=> {
        const edits={...a};
        edits.attach_name = card.querySelector('[data-field="attach_name"]').value;
        edits.attach_category = card.querySelector('[data-field="attach_category"]').value;
        tbl.applyEdits({ updateFeatures:[{ attributes: edits }]})
          .then(()=> refreshCounts())
          .catch(e=> alert("Update error: "+e.message));
      };
      actions.appendChild(save);
      card.appendChild(f1); card.appendChild(f2); card.appendChild(f3); card.appendChild(actions);
      relatedContent.appendChild(card);
    });
    relatedActions.innerHTML = `<button class="btn" id="addAttach">New Attachment</button>`;
    document.getElementById("addAttach").onclick = async ()=>{
      const first = ns.features?.[0]?.attributes?.globalid; if (!first){ alert("No note to attach to."); return; }
      const name = prompt("Attachment name?"); if (name==null) return;
      let cat = attachDomain[0]?.code || "";
      if (attachDomain.length){
        const list = attachDomain.map(cv=>`${cv.code} â€” ${cv.name}`).join("\n");
        const inp = prompt("Category code:\n\n"+list+"\n\nEnter code exactly:"); if (inp && attachDomain.some(cv=>cv.code===inp)) cat=inp;
      }
      const attrs = { parent_guid:first, attach_name:name, attach_category:cat };
      tbl.applyEdits({ addFeatures:[{ attributes: attrs }]})
        .then(()=> renderRelated().then(refreshCounts))
        .catch(e=> alert("Add error: "+e.message));
    };
  }

  function buildPairs(pAttrs, nAttrs, scope){
    const pairs=[];
    const add=(p,n)=>{
      const long=/notes?|desc|plan|summary|comment|constraint/i.test(n);
      pairs.push({ pField:p, nField:n, aliasP:(parcelFields[p]?.alias||p), aliasN:n, pVal:pAttrs[p], nVal:nAttrs[n], long });
    };
    const addFor=(base)=>{ if (base in nAttrs && base in pAttrs) add(base,base); if ((base+"_notes") in nAttrs && base in pAttrs) add(base,base+"_notes"); };
    if (scope){
      addFor(scope);
      if ("s16_lotplan" in nAttrs && "lotplan" in pAttrs){
        pairs.unshift({ pField:"lotplan", nField:"s16_lotplan", aliasP:(parcelFields["lotplan"]?.alias||"Lot/Plan"), aliasN:"Lot/Plan (Note)", pVal:pAttrs.lotplan, nVal:nAttrs.s16_lotplan, long:false });
      }
      return pairs;
    }
    Object.keys(nAttrs).forEach(nf=>{ if (!/^(objectid|globalid|parcelguid|created_|last_edited)/i.test(nf) && (nf in pAttrs)) add(nf,nf); });
    Object.keys(nAttrs).forEach(nf=>{ if (!pairs.find(p=>p.nField===nf)){ const base=nf.replace(/_?notes?$/i,""); if (base && (base in pAttrs)) add(base,nf); }});
    if (!pairs.find(p=>p.pField==="lotplan") && ("s16_lotplan" in nAttrs)){
      pairs.unshift({ pField:"lotplan", nField:"s16_lotplan", aliasP:(parcelFields["lotplan"]?.alias||"Lot/Plan"), aliasN:"Lot/Plan (Note)", pVal:pAttrs.lotplan, nVal:nAttrs.s16_lotplan, long:false });
    }
    return pairs;
  }
  function scopeToNoteFields(base, tbl){
    if (!base) return [];
    const has = (n)=> !!tbl.fields.find(f=>f.name===n);
    const arr=[]; if (has(base)) arr.push(base); if (has(base+"_notes")) arr.push(base+"_notes"); return arr.length?arr:[base];
  }

  // tiny ðŸ“ buttons
  function installFieldNoteButtons(){
    NOTE_FIELDS.forEach(fid=>{
      const input = document.getElementById(fid); if (!input) return;
      const th = input.closest("td")?.previousElementSibling; if (!th || th.querySelector(".mini-note")) return;
      const btn=document.createElement("span"); btn.className="mini-note"; btn.textContent="ðŸ“"; btn.title="Notes for this field";
      btn.onclick = ()=> { noteScopeField=fid; openDrawer("notes"); };
      th.appendChild(btn);
    });
  }

  // HTML escape helper (avoid window.escape collision)
  function htmlEscape(s){ return (s==null?"":String(s)).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  // keep map healthy when layout shifts
  const ro = new ResizeObserver(()=> resizeView());
  ro.observe(document.getElementById("infoPane"));
  ro.observe(document.getElementById("relatedPane"));
});
</script>
