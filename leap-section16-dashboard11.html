<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LEAP Section 16 Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <style>
    :root{ --info-width:380px; --related-width:360px; --related-wide:46vw; }
    html,body,#container{margin:0;padding:0;height:100%}
    #container{display:flex;font-family:Arial,sans-serif}
    #mapPane{position:relative;flex:1;min-width:360px}
    #viewDiv{position:absolute;inset:0}
    #svcWarn{position:absolute;top:10px;left:10px;z-index:5;background:#fff4d6;border:1px solid #f0c36d;border-radius:6px;padding:6px 10px;font-size:.9em;display:none}
    #infoPane{width:var(--info-width);background:#f5f5f5;overflow:auto;padding:20px;box-sizing:border-box;border-left:1px solid #e8e8e8}
    #infoPane h2{margin:0 0 8px;color:#003087}
    .assessment-table{width:100%;border-collapse:collapse}
    .assessment-table th{width:34%;text-align:left;padding:4px 8px;vertical-align:top;font-weight:normal}
    .assessment-table td{padding:4px 8px;vertical-align:top}
    .assessment-table input,.assessment-table textarea{width:100%;box-sizing:border-box;padding:6px 8px;font-size:.95em;border:1px solid #ccc;border-radius:4px;background:#fff}
    .btn{background:#003087;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer}
    .btn:disabled{background:#aaa}
    #relatedPane{width:var(--related-width);max-width:100vw;background:#fff;border-left:1px solid #e8e8e8;display:none;padding:12px;box-sizing:border-box;overflow:auto}
    .open-related #relatedPane{display:block}
    .wide-related #relatedPane{width:var(--related-wide)}
    .tabs{display:flex;gap:8px;margin:10px 0 12px;flex-wrap:wrap}
    .tab{padding:6px 10px;border:1px solid #c9c9c9;border-radius:999px;background:#f8f8f8;cursor:pointer}
    .tab.active{background:#fff;border-color:#888}
    .list{display:flex;flex-direction:column;gap:10px}
    .card{border:1px solid #eee;border-radius:8px;padding:10px}
  </style>
</head>
<body>
  <div id="container">
    <div id="mapPane">
      <div id="svcWarn">Service not reachable yet. Map is usable; related data will appear when it loads.</div>
      <div id="viewDiv"></div>
    </div>

    <div id="infoPane">
      <h2>Section 16 Assessment</h2>
      <p id="startHint">Select a parcel on the map or search a Lot/Plan to begin.</p>

      <div id="formFields" style="display:none;">
        <table class="assessment-table">
          <tr><th>Lot/Plan</th><td><input id="lotplan" disabled/></td></tr>
          <tr><th>Lot</th><td><input id="lot" disabled/></td></tr>
          <tr><th>Plan</th><td><input id="plan" disabled/></td></tr>
          <tr><th>Survey Indicator</th><td><input id="surv_ind" disabled/></td></tr>
          <tr><th>Title Reference</th><td><input id="title_ref"/></td></tr>
          <tr><th>Property Address</th><td><input id="prop_addr"/></td></tr>
          <tr><th>Area (ha)</th><td><input id="lot_area_c"/></td></tr>
          <tr><th>Tenure</th><td><input id="tenure" disabled/></td></tr>
          <tr><th>Registered Owner/Trustee</th><td><input id="reg_owner"/></td></tr>
          <tr><th>LGA</th><td><input id="shire_name" disabled/></td></tr>
        </table>

        <div style="margin-top:12px;text-align:right">
          <button id="saveBtn" class="btn" disabled>Save</button>
          <button id="reportBtn" class="btn" disabled>Report</button>
        </div>
      </div>
    </div>

    <div id="relatedPane">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:6px">
        <strong>Related</strong>
        <div>
          <button id="toggleWide" class="btn" style="background:#28559a">Wide</button>
          <button id="closeRelated" class="btn" style="background:#666">Close</button>
        </div>
      </div>
      <div id="tabs" class="tabs"></div>
      <div id="relatedActions" style="margin-bottom:10px"></div>
      <div id="relatedContent" class="list"></div>
    </div>
  </div>

  <script src="https://js.arcgis.com/4.29/"></script>
  <script>
  window.addEventListener("DOMContentLoaded", function(){

    require([
      "esri/config",
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/layers/GraphicsLayer",
      "esri/layers/WebTileLayer",
      "esri/Basemap",
      "esri/Graphic",
      "esri/widgets/Zoom",
      "esri/widgets/Search"
    ], function(esriConfig, Map, MapView, FeatureLayer, GraphicsLayer, WebTileLayer, Basemap, Graphic, Zoom, Search) {

      // ---------- CONFIG ----------
      esriConfig.request.trustedServers.push("uat-qportal.information.qld.gov.au");
      // Point to the sublayer that holds parcels:
      const PARCEL_URL = "https://uat-qportal.information.qld.gov.au/arcgis/rest/services/LEAP_ClaimParcels_rbt/FeatureServer/0";
      // If your data is still on vegtest, use that instead:
      // const PARCEL_URL = "https://uat-qportal.information.qld.gov.au/arcgis/rest/services/sirrte_idi_LEAP_ClaimParcels_vegtest/FeatureServer/1";

      // ---------- DOM ----------
      const svcWarn   = document.getElementById("svcWarn");
      const startHint = document.getElementById("startHint");
      const form      = document.getElementById("formFields");
      const saveBtn   = document.getElementById("saveBtn");
      const reportBtn = document.getElementById("reportBtn");
      const tabsEl    = document.getElementById("tabs");
      const relatedContent = document.getElementById("relatedContent");
      const relatedActions = document.getElementById("relatedActions");
      const closeRelated = document.getElementById("closeRelated");
      const toggleWide   = document.getElementById("toggleWide");

      // ---------- BASEMAP that works without arcgis.com ----------
      function offlineBasemap(){
        const osm = new WebTileLayer({
          urlTemplate: "https://tile.openstreetmap.org/{level}/{col}/{row}.png",
          copyright: "© OpenStreetMap contributors"
        });
        return new Basemap({ baseLayers: [osm], title: "OpenStreetMap", id: "osm-direct" });
      }

      const map  = new Map({ basemap: offlineBasemap() });
      const view = new MapView({ container: "viewDiv", map, zoom: 6, center: [145,-24] });

      // try to use Imagery if allowed; otherwise stick to OSM
      try { map.basemap = "satellite"; } catch(e) {}
      view.on("layerview-create-error", (evt)=>{
        const isBase = evt?.layer?.type === "tile" || (evt?.layer?.id || "").includes("base");
        if (isBase) {
          console.warn("Basemap failed; reverting to OSM.", evt?.error);
          map.basemap = offlineBasemap();
        }
      });

      view.when(()=>{ view.ui.remove("zoom"); view.ui.add(new Zoom({view}), "top-left"); });

      const search = new Search({ view, includeDefaultSources: true, allPlaceholder: "Search address or Lot/Plan" });
      view.ui.add(search, "top-right");

      const highlightLayer = new GraphicsLayer(); map.add(highlightLayer);

      // ---------- STATE ----------
      let parcelFL=null, relRegistry={}, selected=null;

      // ---------- INIT ----------
      (async function init(){
        parcelFL = await safeLoadFL(PARCEL_URL);
        if (!parcelFL){
          if (svcWarn){
            svcWarn.textContent = "Parcel service is unreachable (network/login). Map is usable; related data will appear once it connects.";
            svcWarn.style.display = "block";
          }
          return;
        }
        map.add(parcelFL);
        try { await view.goTo(parcelFL.fullExtent); } catch(e){}

        // Add Lot/Plan search source once layer is live
        try {
          search.sources.add({
            layer: parcelFL, searchFields:["lotplan"], displayField:"lotplan",
            outFields:["*"], name:"Claim Parcels", placeholder:"e.g. 45SP164230"
          });
        } catch(e){ console.warn(e); }

        // Build simple related tabs
        buildRelatedTabs(parcelFL.relationships || []);

        // select by click
        view.on("click", (evt)=>{
          view.hitTest(evt).then(r=>{
            const hit = r.results.find(x => x.graphic?.layer===parcelFL);
            if (hit) onSelect(hit.graphic); else clearSelection();
          });
        });

        // select by search
        search.on("select-result", (e)=> e.result?.feature && onSelect(e.result.feature));
      })();

      async function safeLoadFL(url){
        const fl = new FeatureLayer({ url, outFields:["*"] });
        try { await fl.load(); return fl; }
        catch(e){ console.warn("Failed to load:", url, e); return null; }
      }

      function onSelect(feature){
        selected = feature;
        fillForm(feature);
        highlight(feature);
        startHint.style.display="none"; form.style.display="block";
        saveBtn.disabled = reportBtn.disabled = false;
        renderRelated(); // refresh counts/content
      }
      function clearSelection(){
        highlightLayer.removeAll();
        selected = null;
        startHint.style.display="block"; form.style.display="none";
        saveBtn.disabled = reportBtn.disabled = true;
        relatedActions.innerHTML = ""; relatedContent.innerHTML = "";
      }
      function fillForm(f){
        const a = f.attributes || {};
        Object.entries(a).forEach(([k,v])=>{
          const el = document.getElementById(k); if (!el) return;
          el.value = (v==null ? "" : (k==="lot_area" ? (v/10000).toFixed(3) : v));
        });
      }
      function highlight(f){
        highlightLayer.removeAll();
        highlightLayer.add(new Graphic({
          geometry:f.geometry,
          symbol:{ type:"simple-fill", color:[0,200,0,0.25], outline:{ color:"#00e0ff", width:2 } }
        }));
        try { view.goTo(f.geometry.extent.expand(1.2)); } catch(e){}
      }

      // ---------- Related (guarded; shows messages until ready) ----------
      function buildRelatedTabs(rels){
        tabsEl.innerHTML = "";
        if (!rels.length){
          const t = document.createElement("div");
          t.className="tab active"; t.textContent="No Related Tables";
          tabsEl.appendChild(t); return;
        }
        relRegistry = {};
        rels.forEach((rel,idx)=>{
          const key = "rel_"+idx;
          relRegistry[key] = rel;
          const tab = document.createElement("div");
          tab.className="tab"; tab.textContent = "Related " + (rel.name || rel.relatedTableId);
          tab.onclick = ()=> openDrawer(key);
          tabsEl.appendChild(tab);
        });
      }

      function openDrawer(key){
        document.body.classList.add("open-related","wide-related");
        if (!parcelFL){
          relatedActions.innerHTML = "";
          relatedContent.innerHTML =
            "<div class='card'>The parcel layer hasn't loaded yet. Once it loads, related tables will appear here.</div>";
          return;
        }
        if (!selected){
          relatedActions.innerHTML = "";
          relatedContent.innerHTML =
            "<div class='card'>Pick a parcel first to view its related records.</div>";
          return;
        }
        renderRelated(key);
      }
      closeRelated.onclick = ()=>{ document.body.classList.remove("open-related","wide-related"); };
      toggleWide.onclick   = ()=>{ document.body.classList.toggle("wide-related"); view.resize(); };

      async function renderRelated(key){
        relatedActions.innerHTML = ""; relatedContent.innerHTML = "";
        if (!parcelFL || !selected){
          relatedContent.innerHTML = "<div class='card'>Waiting for layer / selection…</div>";
          return;
        }
        // For now: simple inspector showing how many related rows exist for each relationship
        const pKey = Object.values(selected.attributes)[0]; // not used; just a placeholder
        relatedContent.innerHTML = "<div class='card'>Related content will appear here (editor UI can be added once relationships are confirmed on the service).</div>";
      }

      // ---------- Save ----------
      saveBtn.onclick = ()=>{
        if (!selected || !parcelFL) return;
        const attrs = {...selected.attributes};
        Object.keys(attrs).forEach(k=>{
          const el=document.getElementById(k); if (el && !el.disabled) attrs[k]=el.value;
        });
        parcelFL.applyEdits({ updateFeatures:[{attributes:attrs}] })
          .then(()=> alert("Saved"))
          .catch(e => alert("Save error: "+e.message));
      };

      // small helper
      function htmlEscape(s){ return (s==null?"":String(s)).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
    });
  });
  </script>
</body>
</html>
