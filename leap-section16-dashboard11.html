<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>LEAP – Section 16 (Dashboard V2)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
<style>
  :root{ --panelW: 33vw; --panelWCollapsed: 300px; --gap: 10px; }
  html,body{height:100%;margin:0}
  #wrap{display:flex;height:100%}
  #map{position:relative;flex:1}
  #view{position:absolute;inset:0}
  /* Right panel */
  #panel{width:var(--panelWCollapsed);max-width:680px;background:#fff;border-left:1px solid #e6e6e6;overflow:auto;transition:width .2s ease}
  #panel.open{width:var(--panelW)}
  #panel .pad{padding:14px}
  h2{margin:6px 0 2px;color:#003087}
  .sub{color:#666;margin:0 0 10px}
  .section{margin:10px 0;border-top:1px solid #eee}
  .section>header{display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:#fff;padding:8px 0;z-index:1}
  .section h3{margin:0;color:#003087;font-weight:600}
  .tools{display:flex;gap:6px}
  .icon{border:1px solid #d0d7e2;border-radius:8px;padding:4px 8px;background:#f5f8ff;cursor:pointer}
  .icon:hover{background:#eaf1ff}
  .row{display:flex;gap:8px;margin:6px 0}
  .row label{width:36%;font-weight:600}
  .row .field{flex:1}
  input,textarea{width:100%;padding:8px 10px;border:1px solid #d9d9d9;border-radius:8px;font-size:14px}
  textarea{min-height:70px;resize:vertical}
  .muted{color:#777}
  .actionbar{display:flex;gap:8px;justify-content:flex-end;margin:14px 0}
  .btn{background:#003087;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.secondary{background:#e9eefc;color:#003087}
  /* related side column */
  #relatedCol{width:280px;border-left:1px solid #e6e6e6;background:#fafbff;display:none;flex-direction:column}
  #relatedCol header{padding:10px;border-bottom:1px solid #e6e6e6;font-weight:600}
  #relatedList{padding:10px;overflow:auto}
  .relItem{border:1px solid #e1e7f5;background:#fff;border-radius:8px;padding:8px;margin:6px 0}
  .relHead{font-weight:600;margin-bottom:4px}
  .pill{display:inline-block;border:1px solid #d0d7e2;border-radius:999px;padding:2px 8px;font-size:12px;background:#f5f8ff;margin-left:6px}
  /* map status */
  #status{position:absolute;left:10px;bottom:10px;background:#0009;color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;display:none}
  /* custom Clear button near Search (sits in map UI) */
  .clearBtn{background:#fff;border:1px solid #d9d9d9;border-radius:8px;padding:6px 10px;box-shadow:0 1px 4px rgba(0,0,0,.08);cursor:pointer}
</style>
<script src="https://js.arcgis.com/4.29/"></script>
</head>
<body>
<div id="wrap">
  <div id="map">
    <div id="view"></div>
    <div id="status"></div>
  </div>

  <div id="panel">
    <div class="pad">
      <h2>Section 16 Assessment <span id="parcelTag" class="pill" style="display:none"></span></h2>
      <div id="startHint" class="muted">Select a parcel on the map or search Lot/Plan.</div>

      <!-- sections container (hidden until a parcel is selected) -->
      <div id="sections" style="display:none"></div>

      <div class="actionbar">
        <button id="saveParcel" class="btn" disabled>Save Parcel</button>
        <button id="toggleRelated" class="btn secondary" style="display:none">Related</button>
      </div>
    </div>
  </div>

  <div id="relatedCol">
    <header>Related notes <span id="relCount" class="pill">0</span></header>
    <div id="relatedList"></div>
  </div>
</div>

<script>
require([
  "esri/config","esri/identity/IdentityManager",
  "esri/Map","esri/views/MapView","esri/layers/FeatureLayer",
  "esri/widgets/Search","esri/Graphic"
], function(esriConfig, esriId, Map, MapView, FeatureLayer, Search, Graphic){

  /* ---------- EDIT THESE ---------- */
  const PORTAL_URL  = "https://uat-qportal.information.qld.gov.au/portal";
  const PARCELS_URL = "https://uat-qportal.information.qld.gov.au/arcgis/rest/services/IDI/LEAP_ClaimParcels_new/FeatureServer/0";
  const NOTES_URL   = "https://uat-qportal.information.qld.gov.au/arcgis/rest/services/IDI/LEAP_ClaimParcels_new/FeatureServer/1";
  const REL_ID      = 0;                // parcels -> notes
  const SEARCH_FIELD= "lotplan";        // change to LOTPLAN if needed
  /* -------------------------------- */

  // trust/CORS
  try{const u=new URL(PARCELS_URL);esriConfig.request.trustedServers.push(`${u.protocol}//${u.host}`);esriConfig.request.corsEnabledServers.push(u.host);}catch(e){}
  esriConfig.portalUrl = PORTAL_URL;

  const $ = (id)=>document.getElementById(id);
  const toast=(t,show=true)=>{const s=$("status");s.textContent=t||"";s.style.display=show?"block":"none";}
  const fmt=(d)=>d?new Date(d).toISOString().slice(0,10):"";

  // layers
  const parcels = new FeatureLayer({ url: PARCELS_URL, outFields:["*"], popupEnabled:false });
  const notes   = new FeatureLayer({ url: NOTES_URL,   outFields:["*"], popupEnabled:false });

  // map
  const map = new Map({ basemap:"satellite", layers:[parcels] });
  const view = new MapView({ container:"view", map, center:[145,-24], zoom:6 });

  // search (map top-right)
  const search = new Search({
    view, includeDefaultSources:false,
    sources:[{ layer:parcels, searchFields:[SEARCH_FIELD], displayField:SEARCH_FIELD, outFields:["*"], name:"Lot/Plan", placeholder:"e.g. 45SP164230", resultGraphicEnabled:false }]
  });
  view.ui.add(search, "top-right");

  // Clear button next to search
  const clearBtn = document.createElement("div");
  clearBtn.className="clearBtn";
  clearBtn.title="Clear selection";
  clearBtn.textContent="Clear";
  clearBtn.onclick = clearSelection;
  view.ui.add(clearBtn, "top-right");

  // sign-in so secured services draw
  esriId.checkSignInStatus(PORTAL_URL + "/sharing").catch(()=>esriId.signIn(PORTAL_URL + "/sharing"));

  // resolve fields (case-insensitive)
  function findField(layer, names){const low=layer.fields.map(f=>f.name.toLowerCase());for(const n of names){const i=low.indexOf(n.toLowerCase());if(i>-1)return layer.fields[i].name;}return null;}
  let F_OID,F_GID,F_LOTPLAN;

  Promise.all([parcels.load(),notes.load()]).then(()=>{
    F_OID     = findField(parcels,["OBJECTID","objectid"]);
    F_GID     = findField(parcels,["globalid","GlobalID","GlobalID_1"]);
    F_LOTPLAN = findField(parcels,[SEARCH_FIELD]);
    if (parcels.fullExtent) view.goTo(parcels.fullExtent);
    toast("");

    view.on("click", onMapClick);
    search.on("select-result", (e)=> e.result?.feature && setParcel(e.result.feature));

    // render static form (hidden initially)
    renderSections();
  }).catch(e=>{console.error(e);toast("Layer failed to load or you are not signed in.");});

  // UI elements
  const panel = $("panel");
  const sectionsHost = $("sections");
  const btnSave = $("saveParcel");
  const btnRel  = $("toggleRelated");

  let selectedParcel=null;

  async function onMapClick(evt){
    const hit = await view.hitTest(evt);
    const g = hit.results?.find(r=>r.graphic?.layer===parcels)?.graphic;
    if (g) setParcel(g); else clearSelection();
  }

  function setParcel(g){
    selectedParcel = g;

    // expand panel + show sections
    panel.classList.add("open");
    sectionsHost.style.display = "block";
    btnSave.disabled = false;
    btnRel.style.display = "inline-block";

    // header tag
    $("parcelTag").style.display="inline-block";
    $("parcelTag").textContent = g.attributes[F_LOTPLAN] || g.attributes[F_GID];

    // blue highlight
    view.graphics.removeAll();
    view.graphics.add(new Graphic({
      geometry:g.geometry,
      symbol:{ type:"simple-fill", color:[0,120,255,0.18], outline:{ type:"simple-line", color:[0,120,255,1], width:2 } }
    }));
    if (g.geometry?.extent) view.goTo(g.geometry.extent.expand(1.2)).catch(()=>{});

    // populate fields
    for(const m of FIELD_MAP){
      const el=$(m.field); if(!el) continue;
      let v = g.attributes[m.field];
      if (m.field==="lot_area" && v!=null) v=(v/10000).toFixed(3);
      el.value = v ?? "";
    }

    // load related (kept lightweight)
    loadRelated();
  }

  function clearSelection(){
    selectedParcel=null;
    view.graphics.removeAll();
    panel.classList.remove("open");
    sectionsHost.style.display = "none";
    btnSave.disabled = true;
    btnRel.style.display = "none";
    $("parcelTag").style.display="none";
    $("relatedCol").style.display="none";
    $("startHint").style.display = "block";
  }

  // Related list
  async function loadRelated(){
    $("relatedList").innerHTML = "<div class='muted'>Loading…</div>";
    if(!selectedParcel){$("relatedCol").style.display="none";return;}
    $("relatedCol").style.display="flex";
    const id = selectedParcel.attributes[F_OID];
    const rel = await parcels.queryRelatedFeatures({ relationshipId: REL_ID, objectIds:[id], outFields:["*"] });
    const rows = rel[id]?.features ?? [];
    $("relCount").textContent = rows.length;
    $("relatedList").innerHTML = rows.length
      ? rows.map(f=>{
          const a=f.attributes; const dt=a.s16_note_date?new Date(a.s16_note_date).toISOString().slice(0,10):"";
          return `<div class="relItem"><div class="relHead">${a.s16_preparedby||"(no author)"} ${dt?("— "+dt):""}</div>
                  <div>${(a.s16_regional_plan||"").substring(0,220)}</div></div>`;
        }).join("")
      : "<div class='muted'>No notes.</div>";
  }
  btnRel.onclick = ()=>{ const rc=$("relatedCol"); rc.style.display = (rc.style.display==="flex")?"none":"flex"; };

  // Save parcel
  btnSave.onclick = ()=>{
    if(!selectedParcel) return;
    const upd = { ...selectedParcel.attributes };
    for(const m of FIELD_MAP){ const el=$(m.field); if(el && m.editable){ upd[m.field] = el.value || null; } }
    parcels.applyEdits({ updateFeatures:[{ attributes:upd }] })
      .then(r=> alert(r.updateFeatureResults?.[0]?.success ? "✅ Saved" : "❌ Save failed"))
      .catch(e=> alert("❌ Save error: "+e.message));
  };

  /* ----------------- FORM LAYOUT -----------------
     Keep/adjust fields to match your schema. These are shown after selection.
  ------------------------------------------------*/
  const SECTIONS = [
    { title:"Parcel Details", items:[
      { field:"lotplan", alias:"Lot/Plan", editable:false },
      { field:"title_ref", alias:"Title Reference", editable:true },
      { field:"prop_addr", alias:"Property Address", editable:true },
      { field:"lot_area", alias:"Area (ha)", editable:true },
      { field:"tenure", alias:"Tenure", editable:false },
      { field:"reg_owner", alias:"Registered Owner/Trustee", editable:true },
      { field:"shire_name", alias:"Local Government Area", editable:false }
    ]},
    { title:"Administrative Attributes", items:[
      { field:"access_l", alias:"Access (Legal)", editable:true },
      { field:"access_p", alias:"Access (Practical)", editable:true },
      { field:"qvas_val", alias:"Current Valuation", editable:true },
      { field:"elvas_ref", alias:"eLVAS Cases", editable:true },
      { field:"surv_ind", alias:"Survey Indicator", editable:false }
    ]},
    { title:"Site History & Background", items:[
      { field:"nt_status", alias:"Native Title Status", editable:true },
      { field:"ind_cul_he", alias:"Indigenous Cult Heritage", editable:true },
      { field:"qld_cul_he", alias:"Qld Cult Heritage", editable:true },
      { field:"ten_hist", alias:"Historical Tenure", editable:true }
    ]},
    { title:"Physical, Biological & Economic", items:[
      { field:"parcel_typ", alias:"Parcel Type", editable:true },
      { field:"cover_typ", alias:"Cover Type", editable:true },
      { field:"plan_const", alias:"Plan Constraints", editable:true, textarea:true },
      { field:"mau", alias:"MAUT Use", editable:true },
      { field:"p_mat", alias:"Past Material", editable:true },
      { field:"mine_int", alias:"Mining Interest", editable:true },
      { field:"epm_app", alias:"EPM App", editable:true },
      { field:"epm_granted", alias:"EPM Granted", editable:true },
      { field:"ml_permit_app", alias:"ML Permit App", editable:true },
      { field:"ml_granted", alias:"ML Granted", editable:true },
      { field:"appln_int", alias:"Exploration Permit", editable:true }
    ]},
    { title:"Environment & Planning", items:[
      { field:"contam_lan", alias:"Contaminated Land", editable:true },
      { field:"stk_route", alias:"Stock Route", editable:true },
      { field:"plan_schem", alias:"State Plan Policy", editable:true },
      { field:"regional_plan", alias:"Regional Plan", editable:true, textarea:true },
      { field:"flooding", alias:"Flood Hazard", editable:true },
      { field:"bushfire", alias:"Bushfire Hazard", editable:true },
      { field:"coastal_mgmt", alias:"Coastal Management", editable:true },
      { field:"veg_mgmt_cat", alias:"Veg Mgmt Categories", editable:true },
      { field:"veg_mgmt_reg_eco", alias:"Veg Mgmt Reg Ecos", editable:true }
    ]},
    { title:"Social & Cultural", items:[
      { field:"cul_mgmt_plan", alias:"Heritage Mgmt Plan", editable:true, textarea:true },
      { field:"cul_studyarea_bdy", alias:"Study Area Bdy", editable:true, textarea:true },
      { field:"cul_party", alias:"Party", editable:true }
    ]}
  ];
  const FIELD_MAP = SECTIONS.flatMap(s=>s.items);

  function renderSections(){
    const host = $("sections"); host.innerHTML = "";
    for(const sec of SECTIONS){
      const secDiv = document.createElement("section");
      secDiv.className="section";
      secDiv.innerHTML = `<header><h3>${sec.title}</h3></header><div class="body"></div>`;
      const body = secDiv.querySelector(".body");
      for(const it of sec.items){
        const ctrl = it.textarea ? `<textarea id="${it.field}" ${it.editable?"":"disabled"}></textarea>`
                                 : `<input id="${it.field}" ${it.editable?"":"disabled"} />`;
        body.insertAdjacentHTML("beforeend",
          `<div class="row"><label for="${it.field}">${it.alias}</label><div class="field">${ctrl}</div></div>`);
      }
      host.appendChild(secDiv);
    }
  }
});
</script>
</body>
</html>
