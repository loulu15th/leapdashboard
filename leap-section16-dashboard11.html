<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>LEAP â€“ Section 16 (Dashboard V2)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
<style>
  :root{ --panelW: 33vw; --panelWCollapsed: 300px; --gap: 10px; }
  html,body{height:100%;margin:0}
  #wrap{display:flex;height:100%}
  #map{position:relative;flex:1}
  #view{position:absolute;inset:0}
  /* Right panel */
  #panel{width:var(--panelWCollapsed);max-width:680px;background:#fff;border-left:1px solid #e6e6e6;overflow:auto;transition:width .2s ease}
  #panel.open{width:var(--panelW)}
  #panel .pad{padding:14px}
  h2{margin:6px 0 2px;color:#003087}
  .sub{color:#666;margin:0 0 10px}
  .section{margin:10px 0;border-top:1px solid #eee}
  .section>header{display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:#fff;padding:8px 0;z-index:1}
  .section h3{margin:0;color:#003087;font-weight:600}
  .tools{display:flex;gap:6px}
  .icon{border:1px solid #d0d7e2;border-radius:8px;padding:4px 8px;background:#f5f8ff;cursor:pointer}
  .icon:hover{background:#eaf1ff}
  .row{display:flex;gap:8px;margin:6px 0}
  .row label{width:36%;font-weight:600}
  .row .field{flex:1}
  input,textarea{width:100%;padding:8px 10px;border:1px solid #d9d9d9;border-radius:8px;font-size:14px}
  textarea{min-height:70px;resize:vertical}
  .muted{color:#777}
  .actionbar{display:flex;gap:8px;justify-content:flex-end;margin:14px 0}
  .btn{background:#003087;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.secondary{background:#e9eefc;color:#003087}
  /* related side column */
  #relatedCol{width:280px;border-left:1px solid #e6e6e6;background:#fafbff;display:none;flex-direction:column}
  #relatedCol header{padding:10px;border-bottom:1px solid #e6e6e6;font-weight:600}
  #relatedList{padding:10px;overflow:auto}
  .relItem{border:1px solid #e1e7f5;background:#fff;border-radius:8px;padding:8px;margin:6px 0}
  .relHead{font-weight:600;margin-bottom:4px}
  .pill{display:inline-block;border:1px solid #d0d7e2;border-radius:999px;padding:2px 8px;font-size:12px;background:#f5f8ff;margin-left:6px}
  /* map status */
  #status{position:absolute;left:10px;bottom:10px;background:#0009;color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;display:none}
  /* custom Clear button near Search (sits in map UI) */
  .clearBtn{background:#fff;border:1px solid #d9d9d9;border-radius:8px;padding:6px 10px;box-shadow:0 1px 4px rgba(0,0,0,.08);cursor:pointer}
</style>
<script src="https://js.arcgis.com/4.29/"></script>
</head>
<body>
<div id="wrap">
  <div id="map">
    <div id="view"></div>
    <div id="status"></div>
  </div>

  <div id="panel">
    <div class="pad">
      <h2>Section 16 Assessment <span id="parcelTag" class="pill" style="display:none"></span></h2>
      <div id="startHint" class="muted">Select a parcel on the map or search Lot/Plan.</div>

      <!-- sections container (hidden until a parcel is selected) -->
      <div id="sections" style="display:none"></div>

      <div class="actionbar">
        <button id="saveParcel" class="btn" disabled>Save Parcel</button>
        <button id="toggleRelated" class="btn secondary" style="display:none">Related</button>
      </div>
    </div>
  </div>

  <div id="relatedCol">
    <header>Related notes <span id="relCount" class="pill">0</span></header>
    <div id="relatedList"></div>
  </div>
</div>

<script>
require([
  "esri/config","esri/identity/IdentityManager",
  "esri/Map","esri/views/MapView","esri/layers/FeatureLayer",
  "esri/widgets/Search","esri/Graphic"
], function(esriConfig, esriId, Map, MapView, FeatureLayer, Search, Graphic){

  /* ---------- EDIT THESE ---------- */
  const PORTAL_URL  = "https://uat-qportal.information.qld.gov.au/portal";
  const PARCELS_URL = "https://uat-qportal.information.qld.gov.au/arcgis/rest/services/IDI/LEAP_ClaimParcels_new/FeatureServer/0";
  const NOTES_URL   = "https://uat-qportal.information.qld.gov.au/arcgis/rest/services/IDI/LEAP_ClaimParcels_new/FeatureServer/1";
  const REL_ID      = 0;                // parcels -> notes
  const SEARCH_FIELD= "lotplan";        // change to LOTPLAN if needed
  /* -------------------------------- */

  // trust/CORS
  try{const u=new URL(PARCELS_URL);esriConfig.request.trustedServers.push(`${u.protocol}//${u.host}`);esriConfig.request.corsEnabledServers.push(u.host);}catch(e){}
  esriConfig.portalUrl = PORTAL_URL;

  const $ = (id)=>document.getElementById(id);
  const toast=(t,show=true)=>{const s=$("status");s.textContent=t||"";s.style.display=show?"block":"none";}
  const fmt=(d)=>d?new Date(d).toISOString().slice(0,10):"";

  // layers
  const parcels = new FeatureLayer({ url: PARCELS_URL, outFields:["*"], popupEnabled:false });
  const notes   = new FeatureLayer({ url: NOTES_URL,   outFields:["*"], popupEnabled:false });

  // map
  const map = new Map({ basemap:"satellite", layers:[parcels] });
  const view = new MapView({ container:"view", map, center:[145,-24], zoom:6 });

  // search (map top-right)
  const search = new Search({
    view, includeDefaultSources:false,
    sources:[{ layer:parcels, searchFields:[SEARCH_FIELD], displayField:SEARCH_FIELD, outFields:["*"], name:"Lot/Plan", placeholder:"e.g. 45SP164230", resultGraphicEnabled:false }]
  });
  view.ui.add(search, "top-right");

  // Clear button next to search
  const clearBtn = document.createElement("div");
  clearBtn.className="clearBtn";
  clearBtn.title="Clear selection";
  clearBtn.textContent="Clear";
  clearBtn.onclick = clearSelection;
  view.ui.add(clearBtn, "top-right");

  // sign-in so secured services draw
  esriId.checkSignInStatus(PORTAL_URL + "/sharing").catch(()=>esriId.signIn(PORTAL_URL + "/sharing"));

  // resolve fields (case-insensitive)
  function findField(layer, names){const low=layer.fields.map(f=>f.name.toLowerCase());for(const n of names){const i=low.indexOf(n.toLowerCase());
