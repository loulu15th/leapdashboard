<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LEAP — Section 16 Editor (Map + Feature Form + Attachments)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>
  <style>
    :root { --gap: 14px; --panelW: 460px; }
    html, body { height: 100%; margin: 0; font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; background:#f6f7f9;}
    header { padding: 10px 14px; font-weight: 700; background:#fff; border-bottom:1px solid #e9e9e9;}
    .app { display: grid; grid-template-columns: 1fr var(--panelW); gap: var(--gap);
           height: calc(100vh - 48px); padding: 12px; box-sizing: border-box; }
    #viewDiv { border: 1px solid #e3e3e3; border-radius: 12px; background:#fff;}
    .panel { display: flex; flex-direction: column; gap: var(--gap); }
    .card { border: 1px solid #e9e9e9; border-radius: 12px; padding: 12px; background: #fff; box-shadow:0 10px 30px rgba(0,0,0,.05);}
    .row { display: flex; gap: 8px; align-items: center; }
    .row input[type="text"] { flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; background:#fff; }
    .btn { padding: 8px 12px; border: 0; border-radius: 10px; background: #0ea5e9; color: #fff; cursor: pointer; font-weight:600;}
    .btn.secondary { background: #f1f3f4; color: #2a2a2a; }
    .pill { padding: 8px 12px; border-radius: 99px; background: #f4f6f8; display: inline-block; }
    .small { color: #666; font-size: 12px; }
    #statusBar { height: 36px; border-radius: 10px; background: #0f172a; color: #fff; display:flex;
                 align-items:center; padding: 0 10px; font-size: 12px; overflow: auto; white-space: nowrap; }
    details { border: 1px dashed #e0e0e0; border-radius: 10px; padding: 8px; }
    details > summary { cursor: pointer; font-weight: 600; }
    ul.attach { list-style: none; padding: 0; margin: 0; display: grid; gap: 6px; }
    ul.attach li { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    ul.attach a { text-decoration: none; }
    .danger { background: #fee2e2; color: #7f1d1d; border: 0; border-radius: 8px; padding: 4px 8px; cursor: pointer; }
    footer { display: flex; gap: 8px; }
  </style>
</head>
<body>
  <header>LEAP — Section 16 Editor (Map + Feature Form + Attachments) <span class="small">ArcGIS JS 4.29</span></header>

  <div class="app">
    <div id="viewDiv"></div>

    <div class="panel">
      <div class="card">
        <div class="row">
          <input id="searchBox" type="text" placeholder="Search by Lot/Plan (e.g. 45SP164230)" />
          <button class="btn" id="findBtn">Find</button>
          <button class="btn secondary" id="clearBtn">Clear</button>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px;">
          <a class="pill small" href="https://sppims-dams.dsdilgp.qld.gov.au/spp/?tab=layers" target="_blank">SPP Viewer</a>
          <a class="pill small" href="https://qldglobe.information.qld.gov.au/" target="_blank">QLD Globe</a>
          <span id="selInfo" class="pill small">No feature selected</span>
        </div>
      </div>

      <div class="card">
        <strong>Feature Form</strong>
        <div id="formDiv" class="small">Tip: select a parcel to edit. Cadastral fields 1–9 are read-only.</div>
      </div>

      <div class="card">
        <strong>Attachments</strong>
        <div class="small" style="margin:6px 0;">Add site photos/documents. Accepted types follow your layer settings.</div>
        <input type="file" id="fileInput" multiple />
        <ul id="attachList" class="attach"></ul>
      </div>

      <details class="card">
        <summary>Related records &amp; geometry (Editor)</summary>
        <div id="editorDiv" style="margin-top:8px;"></div>
      </details>

      <div class="card"><div id="statusBar">Ready.</div></div>

      <footer>
        <button class="btn secondary" id="resetBtn">Reset changes</button>
        <button class="btn" id="saveBtn">Save</button>
      </footer>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const CONFIG = {
      LAYER_URL: "https://services8.arcgis.com/N9pWXvW1bA4UHL2O/arcgis/rest/services/ClaimParcels_vegtest/FeatureServer/1",
      LOTPLAN_FIELD: "lotplan",                 // exact field name for Lot/Plan search
      SEARCH_WILDCARD: true,                    // LIKE '%term%' if true
      LOCK_FIRST_N_IN_FORM_TEMPLATE: 9,         // <- lock form elements 1–9
      READONLY_FIELDS: []                       // fallback list, e.g. ["lot","plan","lotplan"]
    };
    // ==========================

    let view, layer, form, selectedFeature, editor;

    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/widgets/FeatureForm",
      "esri/widgets/Editor",
      "esri/rest/support/Query",
      "esri/core/reactiveUtils",
      "esri/Graphic"
    ], (
      Map, MapView, FeatureLayer, FeatureForm, Editor, Query, reactiveUtils, Graphic
    ) => {
      layer = new FeatureLayer({
        url: CONFIG.LAYER_URL,
        outFields: ["*"],
        title: "Claim Parcels",
        popupEnabled: false
      });

      const map = new Map({ basemap: "arcgis-topographic", layers: [layer] });

      view = new MapView({
        container: "viewDiv",
        map,
        center: [153.026, -27.469],
        zoom: 11
      });

      // Editor (for related records/geometry if needed)
      editor = new Editor({
        view,
        container: "editorDiv",
        allowedWorkflows: ["update"],
        layerInfos: [{ layer, enableGeometryUpdates: true }]
      });

      document.getElementById("findBtn").onclick = onFind;
      document.getElementById("clearBtn").onclick = clearSelection;
      document.getElementById("saveBtn").onclick = () => form && form.submit();
      document.getElementById("resetBtn").onclick = () => form && (form.feature = selectedFeature);
      document.getElementById("fileInput").addEventListener("change", onFilesChosen);

      const status = (msg) => document.getElementById("statusBar").textContent = msg;

      // Build fieldConfig: lock first N from form template order; fallback to explicit names
      async function makeFieldConfig() {
        await layer.load();
        const explicit = new Set((CONFIG.READONLY_FIELDS || []).map(s => s.toLowerCase()));
        const order = [];

        // Try to read the saved Smart Form (FormTemplate) from the layer
        const t = layer.formTemplate || (layer.getFormTemplate && layer.getFormTemplate());
        if (t && t.elements && t.elements.length) {
          const collect = (els) => {
            els.forEach(el => {
              if (el.fieldName) order.push(el.fieldName);
              if (el.elements && el.elements.length) collect(el.elements);
            });
          };
          collect(t.elements);
        }

        const lockSet = new Set();
        // Lock first N by order (Spreadsheet’s “1–9 cadastral” should be first in your template)
        if (order.length && CONFIG.LOCK_FIRST_N_IN_FORM_TEMPLATE > 0) {
          order.slice(0, CONFIG.LOCK_FIRST_N_IN_FORM_TEMPLATE).forEach(n => lockSet.add(n.toLowerCase()));
        }
        // Also lock explicit names, if any
        explicit.forEach(n => lockSet.add(n));

        // Build config (preserve order: prefer template order; then others)
        const allFields = layer.fields
          .filter(f => !/^shape/i.test(f.name) && f.name !== layer.objectIdField && !/^globalid$/i.test(f.name));
        const byName = new Map(allFields.map(f => [f.name, f]));

        const orderedNames = [...new Set([...order, ...allFields.map(f => f.name)])];
        return orderedNames
          .filter(n => byName.has(n))
          .map(n => {
            const f = byName.get(n);
            return {
              name: f.name,
              label: f.alias || f.name,
              editable: !lockSet.has(f.name.toLowerCase()) && f.editable !== false
            };
          });
      }

      function wireFormEvents() {
        if (!form) return;
        form.on("submit", async (evt) => {
          evt.preventDefault();
          if (!selectedFeature) return;
          try {
            const oidField = layer.objectIdField;
            const update = { attributes: { ...selectedFeature.attributes, ...evt.values } };
            update.attributes[oidField] = selectedFeature.attributes[oidField];

            status("Saving…");
            const res = await layer.applyEdits({ updateFeatures: [update] });
            const r = res.updateFeatureResults?.[0];
            if (r?.error) throw r.error;

            // Refresh selected feature
            const q = layer.createQuery();
            q.objectIds = [update.attributes[oidField]];
            q.outFields = ["*"];
            q.returnGeometry = true;
            const fresh = await layer.queryFeatures(q);
            selectedFeature = fresh.features[0];
            form.feature = selectedFeature;

            await refreshAttachments();
            status("Saved.");
          } catch (e) {
            console.error(e);
            status("Save failed: " + (e.message || e));
          }
        });
      }

      async function onFind() {
        try {
          const term = document.getElementById("searchBox").value.trim();
          if (!term) return;

          const q = layer.createQuery();
          const fld = CONFIG.LOTPLAN_FIELD;
          q.where = CONFIG.SEARCH_WILDCARD
            ? `${fld} LIKE '%${term.replace(/'/g, "''")}%'`
            : `${fld} = '${term.replace(/'/g, "''")}'`;
          q.outFields = ["*"];
          q.returnGeometry = true;

          status("Searching…");
          const res = await layer.queryFeatures(q);
          if (!res.features.length) { status("No results."); return; }
          selectedFeature = res.features[0];

          await view.goTo({ target: selectedFeature, zoom: 18 }, { duration: 600 });
          document.getElementById("selInfo").textContent =
            `${CONFIG.LOTPLAN_FIELD}: ${selectedFeature.attributes[CONFIG.LOTPLAN_FIELD] ?? "(n/a)"}`;

          // Create/replace FeatureForm with locked fields
          if (form) form.destroy();
          form = new FeatureForm({
            container: "formDiv",
            layer,
            feature: selectedFeature,
            groupDisplay: "sequential",
            fieldConfig: await makeFieldConfig()
          });
          wireFormEvents();

          await refreshAttachments();
          status(`Selected 1 of ${res.features.length} match(es).`);
        } catch (e) {
          console.error(e);
          status("Search failed: " + (e.message || e));
        }
      }

      function clearSelection() {
        selectedFeature = null;
        document.getElementById("selInfo").textContent = "No feature selected";
        document.getElementById("attachList").innerHTML = "";
        document.getElementById("fileInput").value = "";
        if (form) { form.destroy(); form = null; }
        document.getElementById("formDiv").innerHTML =
          '<span class="small">Tip: select a parcel to edit. Cadastral fields 1–9 are read-only.</span>';
        status("Cleared.");
      }

      async function refreshAttachments() {
        const list = document.getElementById("attachList");
        list.innerHTML = "";
        if (!selectedFeature) return;

        const oid = selectedFeature.getObjectId();
        try {
          const result = await layer.queryAttachments({ objectIds: [oid] });
          const rows = result[oid] || [];
          if (!rows.length) { list.innerHTML = '<li class="small">No attachments.</li>'; return; }
          rows.forEach(att => {
            const li = document.createElement("li");
            const a = document.createElement("a");
            a.textContent = att.name || ("Attachment " + att.id);
            a.target = "_blank";
            a.href = `${layer.url}/${oid}/attachments/${att.id}`;
            const del = document.createElement("button");
            del.className = "danger";
            del.textContent = "Delete";
            del.onclick = () => deleteAttachment(oid, att.id);
            li.appendChild(a);
            li.appendChild(del);
            list.appendChild(li);
          });
        } catch (e) {
          console.error(e);
          list.innerHTML = '<li class="small">Could not load attachments.</li>';
        }
      }

      async function onFilesChosen(ev) {
        if (!selectedFeature) return;
        const files = Array.from(ev.target.files || []);
        if (!files.length) return;

        const oid = selectedFeature.getObjectId();
        status("Uploading attachment(s)…");
        try {
          const adds = files.map(file => ({ objectId: oid, attachment: file }));
          const res = await layer.applyEdits({ addAttachments: adds });
          const err = res.addAttachmentResults?.find(r => r.error)?.error;
          if (err) throw err;
          await refreshAttachments();
          status("Attachment(s) uploaded.");
        } catch (e) {
          console.error(e);
          status("Upload failed: " + (e.message || e));
        } finally {
          ev.target.value = "";
        }
      }

      async function deleteAttachment(objectId, attachmentId) {
        status("Deleting attachment…");
        try {
          const res = await layer.applyEdits({
            deleteAttachments: [{ objectId, attachmentIds: [attachmentId] }]
          });
          const err = res.deleteAttachmentResults?.[0]?.error;
          if (err) throw err;
          await refreshAttachments();
          status("Attachment deleted.");
        } catch (e) {
          console.error(e);
          status("Delete failed: " + (e.message || e));
        }
      }
    });
  </script>
</body>
</html>
