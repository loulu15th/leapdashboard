<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>LEAP – Section 16 Dashboard (UAT)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css"/>
  <style>
    html,body,#view{height:100%;margin:0}
    .panel{position:absolute;top:10px;right:10px;width:420px;max-height:90%;overflow:auto;background:#fff;
      border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.25);padding:12px}
    .row{margin:8px 0}
    label{display:block;font-weight:600;margin-bottom:4px}
    input,textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px}
    button{padding:8px 12px;border:0;border-radius:8px;cursor:pointer}
    .primary{background:#2563eb;color:#fff}
    .danger{background:#b91c1c;color:#fff}
    .muted{color:#666}
    .list-item{border:1px solid #eee;border-radius:10px;padding:8px;margin:6px 0}
    #status{position:absolute;left:10px;bottom:10px;background:#0008;color:#fff;padding:6px 10px;border-radius:8px;font-size:12px}
  </style>
  <script src="https://js.arcgis.com/4.29/"></script>
</head>
<body>
<div id="view"></div>
<div id="status" style="display:none;"></div>

<div class="panel">
  <h3 style="margin:4px 0 8px">LEAP – Section 16 Notes</h3>
  <div class="muted">Click a parcel (or use the map search) to view and edit related notes.</div>

  <div id="parcelInfo" class="row muted" style="margin-top:8px">No parcel selected.</div>

  <div class="row">
    <h4 style="margin:8px 0">Related Notes <span id="noteCount">0</span></h4>
    <div id="noteList"></div>
  </div>

  <hr/>

  <div class="row"><h4 style="margin:8px 0">Add / Edit Note</h4></div>
  <div class="row"><label>Lot &amp; Plan (auto or manual)</label><input id="f_lotplan" maxlength="100"/></div>
  <div class="row"><label>Prepared by</label><input id="f_preparedby" maxlength="100"/></div>
  <div class="row"><label>Note Date</label><input id="f_date" type="date"/></div>
  <div class="row"><label>Regional Planning</label><textarea id="f_regional_plan" rows="2" maxlength="2000"></textarea></div>
  <div class="row"><label>Recommendations</label><textarea id="f_recommendations" rows="3" maxlength="4000"></textarea></div>

  <div class="row">
    <button id="btnSave" class="primary">Save Note</button>
    <button id="btnDelete" class="danger" style="display:none">Delete Selected</button>
    <span id="msg" class="muted" style="margin-left:8px"></span>
  </div>
</div>

<script>
require([
  "esri/config",
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/widgets/Search",
  "esri/Graphic",
  "esri/rest/support/Query"
], function(esriConfig, Map, MapView, FeatureLayer, Search, Graphic, Query) {

  // ======= CONFIG (EDIT THESE THREE) =======
  const CONFIG = {
    parcelsUrl: "https://YOUR-SERVER/arcgis/rest/services/IDI/LEAP_ClaimParcels_new/FeatureServer/0",
    notesUrl:   "https://YOUR-SERVER/arcgis/rest/services/IDI/LEAP_ClaimParcels_new/FeatureServer/1",
    relationshipId: 0  // relationship id on the parcels layer pointing to notes table
  };

  // Auto-add server to trusted list (handles cross-domain auth when you’re already signed in)
  try {
    const u = new URL(CONFIG.parcelsUrl);
    esriConfig.request.trustedServers.push(`${u.protocol}//${u.host}`);
  } catch(e){ /* ignore */ }

  // ======= HELPERS =======
  const $ = id => document.getElementById(id);
  const toast = (t,show=true)=>{$("status").style.display=show?"block":"none";$("status").textContent=t||"";}
  const msg = t => ($("msg").textContent = t || "");
  const byNameCI = (arr, name) => arr.find(f => f.name.toLowerCase() === name.toLowerCase());
  const findField = (layer, candidates) => {
    for (const c of candidates) { const f = byNameCI(layer.fields, c); if (f) return f.name; }
    return null;
  };
  const fmtDate = d => d ? new Date(d).toISOString().slice(0,10) : "";

  // ======= LAYERS =======
  const parcels = new FeatureLayer({
    url: CONFIG.parcelsUrl,
    popupEnabled: false // we drive the UI
  });
  const notes = new FeatureLayer({
    url: CONFIG.notesUrl
  });

  // ======= MAP / VIEW =======
  const map = new Map({ basemap: "hybrid", layers: [parcels] }); // satellite + labels
  const view = new MapView({ container: "view", map, center: [153.03,-27.47], zoom: 10, constraints: { snapToZoom:false } });

  // ======= STATE (resolved field names at runtime) =======
  let F_OBJECTID, F_GLOBALID, F_LOTPLAN;     // on parcels
  let F_CHILD_OID, F_CHILD_FK, F_S16_LOTPLAN, F_S16_PREP, F_S16_DATE, F_S16_RP, F_S16_REC; // on notes
  let selectedParcel = null;   // Graphic
  let selectedNoteOID = null;  // number

  // Resolve fields once layers load
  Promise.all([parcels.load(), notes.load()]).then(() => {
    // detect fields on parcels
    F_OBJECTID = findField(parcels, ["OBJECTID","objectid"]);
    F_GLOBALID = findField(parcels, ["globalid","GlobalID","GlobalID_1"]);
    F_LOTPLAN  = findField(parcels, ["lotplan","LotPlan","LOTPLAN"]);

    if (!F_OBJECTID || !F_GLOBALID) {
      toast("Parcel layer loaded, but OBJECTID/GlobalID field not found. Check service fields.", true);
      console.error("Fields", parcels.fields.map(f=>f.name));
    } else {
      // detect fields on notes
      F_CHILD_OID  = findField(notes, ["OBJECTID","objectid"]);
      F_CHILD_FK   = findField(notes, ["parcelguid","ParcelGUID","guid"]);
      F_S16_LOTPLAN= findField(notes, ["s16_lotplan","S16_lotplan"]);
      F_S16_PREP   = findField(notes, ["s16_preparedby","S16_preparedby"]);
      F_S16_DATE   = findField(notes, ["s16_note_date","S16_note_date"]);
      F_S16_RP     = findField(notes, ["s16_regional_plan","S16_regional_plan"]);
      F_S16_REC    = findField(notes, ["s16_recommendations","S16_recommendations"]);

      // build Search widget (top-right) using the resolved lotplan field
      const search = new Search({
        view,
        includeDefaultSources: false,
        sources: [{
          layer: parcels,
          name: "Search Lot/Plan",
          searchFields: F_LOTPLAN ? [F_LOTPLAN] : [],
          suggestionTemplate: `{${F_LOTPLAN || "NAME"}}`,
          exactMatch: false,
          outFields: ["*"],
          placeholder: "e.g. 45SP164230",
          maxSuggestions: 8,
          autoNavigate: true,
          resultGraphicEnabled: false
        }]
      });
      view.ui.add(search, "top-right");

      // select from search
      search.on("select-result", (ev) => {
        if (ev.result?.feature) selectParcel(ev.result.feature);
      });

      toast(""); // clear any status
    }
  }).catch(err => {
    toast("Layer failed to load. Check URL/sharing and that you’re signed in to the portal.", true);
    console.error("Layer load error", err);
  });

  // ======= Parcel selection =======
  function setParcelInfo(g) {
    if (!g) { $("parcelInfo").textContent = "No parcel selected."; return; }
    const a = g.attributes;
    $("parcelInfo").innerHTML =
      `<b>Lot/Plan:</b> ${a[F_LOTPLAN] ?? ""}`;
    if (!$("f_lotplan").value && a[F_LOTPLAN]) $("f_lotplan").value = a[F_LOTPLAN];
  }

  async function selectParcel(graphic) {
    selectedParcel = graphic;
    view.graphics.removeAll();
    view.graphics.add(new Graphic({
      geometry: graphic.geometry,
      symbol: { type: "simple-fill", style: "none", outline: { type: "simple-line", width: 2 } }
    }));
    setParcelInfo(graphic);
    await loadRelatedNotes();
  }

  view.on("click", async (e) => {
    try {
      const hit = await view.hitTest(e);
      const g = hit.results?.find(r => r.graphic?.layer === parcels)?.graphic;
      if (g) selectParcel(g);
    } catch (err) { console.error("HitTest error", err); }
  });

  // ======= Load related notes =======
  async function loadRelatedNotes() {
    try {
      msg("Loading…");
      selectedNoteOID = null;
      const rel = await parcels.queryRelatedFeatures({
        relationshipId: CONFIG.relationshipId,
        objectIds: [ selectedParcel.attributes[F_OBJECTID] ],
        outFields: ["*"]
      });
      const rows = rel[selectedParcel.attributes[F_OBJECTID]]?.features ?? [];
      $("noteCount").textContent = rows.length;
      const list = rows.map(f => {
        const o = f.attributes;
        const when = o[F_S16_DATE] ? new Date(o[F_S16_DATE]).toISOString().slice(0,10) : "";
        return `<div class="list-item" data-oid="${o[F_CHILD_OID]}">
          <div><b>${o[F_S16_PREP] || "(no author)"} — ${when}</b></div>
          <div class="muted">${(o[F_S16_RP] || "").substring(0,160)}</div>
          <div class="muted"><i>LotPlan:</i> ${o[F_S16_LOTPLAN] || ""}</div>
        </div>`;
      }).join("") || `<div class="muted">No notes yet.</div>`;
      $("noteList").innerHTML = list;
      msg("");

      // click-to-edit existing note
      document.querySelectorAll("#noteList .list-item").forEach(div => {
        div.onclick = async () => {
          selectedNoteOID = +div.getAttribute("data-oid");
          const { features } = await notes.queryFeatures({ where: `${F_CHILD_OID}=${selectedNoteOID}`, outFields: ["*"] });
          if (features.length) {
            const a = features[0].attributes;
            $("f_lotplan").value = a[F_S16_LOTPLAN] || "";
            $("f_preparedby").value = a[F_S16_]()_
