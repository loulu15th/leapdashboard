<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>LEAP Section‚ÄØ16 Dashboard</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f5f5f5; }
    .header { background: linear-gradient(135deg,#003087,#0066cc); color:#fff; padding:15px; text-align:center; }
    .header h1 { margin:0; font-size:2em; }
    .main { display:grid; grid-template-columns:1fr 1.1fr; height:calc(100vh - 65px); }
    #mapView { width:100%; height:100%; }
    .rightPanel { background:#fff; overflow-y:auto; padding:20px; box-shadow:-2px 0 5px rgba(0,0,0,0.1); }
    .section-title { color:#003087; margin-top:20px; margin-bottom:10px; font-size:1.2em; border-bottom:2px solid #e9ecef; padding-bottom:5px; }
    table { width:100%; border-collapse:collapse; margin-bottom:15px; }
    th,td { padding:8px; border:1px solid #ddd; vertical-align:top; }
    th { width:35%; background:#e9ecef; }
    .readonly { background:#f0f0f0; }
    .editable { background:#fff; border:1px dashed #ccc; padding:4px; border-radius:4px; min-height:20px; }
    .editable:focus { outline:none; border-color:#003087; background:#f0f8ff; }
    .external-link { color:#28a745; text-decoration:none; font-size:0.85em; margin-left:5px; }
    .external-link:hover { text-decoration:underline; }
    .btn { background:#003087; color:#fff; border:none; padding:8px 14px; border-radius:4px; cursor:pointer; margin-right:5px; }
    .btn:hover { background:#0066cc; }
    .hint { color:#856404; font-size:0.85em; }
    #searchDiv { padding:10px; background:#fff; }
    #searchDiv input { width:100%; padding:6px; border:1px solid #ccc; border-radius:4px; }
  </style>
  <script src="https://js.arcgis.com/4.28/"></script>
</head>
<body>
  <div class="header">
    <h1>üèõÔ∏è LEAP Section‚ÄØ16 Dashboard</h1>
  </div>
  <div class="main">
    <div id="mapView"></div>
    <div class="rightPanel">
      <div id="searchDiv">
        <input id="lotSearch" type="text" placeholder="Search Lot/Plan (e.g. 45)" />
      </div>
      <div id="parcelSummary">
        <p><em>Select a parcel on the map or search above</em></p>
      </div>
      <div id="formContent"></div>
      <div style="text-align:center; margin:20px 0;">
        <button class="btn" id="saveBtn">üíæ Save</button>
        <button class="btn" id="reportBtn">üìÑ Generate Report</button>
      </div>
    </div>
  </div>

  <script>
    require([
      "esri/Map", "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/widgets/Search",
      "esri/identity/IdentityManager",
      "esri/widgets/Sketch/SketchViewModel"
    ], function(Map, MapView, FeatureLayer, Search, esriId, SketchVM) {

      const LEAP_SERVICE = "https://uat-qportal.information.qld.gov.au/arcgis/rest/services/sirrte_idi_LEAP_ClaimParcels_vegtest/MapServer/1";
      let view, parcelsLayer, currentFeat;

      esriId.getCredential(LEAP_SERVICE)
        .then(cred => initDashboard(cred.token))
        .catch(() => initDashboard());

      function initDashboard(token) {
        const map = new Map({ basemap:"satellite" });
        view = new MapView({ container:"mapView", map, center:[152.7,-27.3], zoom:8 });
        parcelsLayer = new FeatureLayer({
          url:LEAP_SERVICE,
          outFields:["*"],
          popupEnabled:false,
          customParameters: token?{token}:null
        });
        map.add(parcelsLayer);

        // Search widget for lotplan
        const search = new Search({
          view, allSources:[{
            layer:parcelsLayer,
            searchFields:["lotplan"],
            displayField:"lotplan",
            exactMatch:false,
            outFields:["*"],
            name:"Lot/Plan Search",
            placeholder:"e.g. 45 on SP164230"
          }]
        });
        view.ui.add(search, { position:"top-left", index:0 });

        // click/select
        view.on("click", evt => {
          view.hitTest(evt).then(res=>{
            const hit = res.results.find(r=>r.graphic.layer===parcelsLayer);
            if(hit) selectParcel(hit.graphic);
          });
        });

        // also hook up the input box
        document.getElementById("lotSearch")
          .addEventListener("change", e=>{
            search.search(e.target.value);
          });

        view.when(() => {
          search.on("select-result", evt => {
            selectParcel(evt.result.feature);
          });
        });

        // Save button
        document.getElementById("saveBtn").addEventListener("click", saveEdits);
        document.getElementById("reportBtn").addEventListener("click", generateReport);
      }

      function selectParcel(graphic) {
        currentFeat = graphic;
        const a = graphic.attributes;
        // Summary
        document.getElementById("parcelSummary").innerHTML = `
          <h3>üìç ${a.lotplan || "Unknown"}</h3>
          <p><strong>Owner:</strong> ${a.claim_n||a.claimName||"Unknown"}</p>
          <p><strong>Area:</strong> ${a.lot_area? (a.lot_area/10000).toFixed(2)+"‚ÄØha":"Unknown"}</p>
        `;
        // Build form
        buildForm(a);
        view.goTo({ target:graphic.geometry, zoom:12 });
      }

      function buildForm(f) {
        // helper to render readonly or contenteditable
        const cell = (val, editable, placeholder="", hint="") => `
          <td class="${editable? "" : "readonly"}">
            ${editable
              ?`<div class="editable" contenteditable="true"
                  data-field="${val.field}"
                  placeholder="${placeholder}"
                  >${f[val.field]||""}</div>`
              : (f[val.field]!==null?f[val.field]:"")
            }
            ${hint? `<div class="hint">${hint}</div>` : ""}
          </td>`;
        // now assemble sections
        let html = "";

        // 1. Parcel Details
        html += `<div class="section-title">üìã Parcel Details</div>
          <table>
            <tr>
              <th>Lot/Plan:</th>
              ${cell({field:"lotplan"}, false)}
            </tr>
            <tr>
              <th>Title Reference:</th>
              ${cell({field:"title_ref"}, true,"Enter title ref","Confirm via QVAS")}
            </tr>
            <tr>
              <th>Property Address:</th>
              ${cell({field:"prop_addr"}, true,"Enter address","")}
            </tr>
            <tr>
              <th>Area (ha):</th>
              ${cell({field:"lot_area"}, false,"","")}
            </tr>
            <tr>
              <th>Tenure:</th>
              ${cell({field:"tenure"}, false,"","")}
            </tr>
            <tr>
              <th>Registered Trustee:</th>
              ${cell({field:"reg_owner"}, true,"Enter trustee","")}
            </tr>
            <tr>
              <th>Local Government Area:</th>
              ${cell({field:"shire_name"}, false,"","")}
            </tr>
          </table>`;

        // 2. Administrative
        html += `<div class="section-title">üîß Administrative Attributes</div>
          <table>
            <tr><th>Access:</th>${cell({field:"access_l"}, true,"Describe access","")}</tr>
            <tr><th>Survey Requirements:</th>${cell({field:"surv_ind"}, true,"Y/N","")}</tr>
            <tr><th>Registered Interests:</th>${cell({field:"all_dis_re"}, true,"List easements/encumbrances","")}</tr>
            <tr>
              <th>Current Valuation:</th>
              ${cell({field:"qvas_val"}, true,"Enter $ val","Use QVAS if unknown")}
            </tr>
            <tr>
              <th>eLVAS & File Check:</th>
              ${cell({field:"elvas_ref"}, true,"File note refs","")}
            </tr>
          </table>`;

        // 3. Site History
        html += `<div class="section-title">üìö Site History & Background</div>
          <table>
            <tr>
              <th>Historical Notes:</th>
              ${cell({field:"ten_hist"}, true,"Enter history","")}
            </tr>
          </table>`;

        // 4. Physical/Bio/Econ
        html += `<div class="section-title">üåç Physical, Biological & Economic</div>
          <table>
            <tr>
              <th>Current Use / Encroachments:</th>
              ${cell({field:"p_mat"}, true,"Describe current use","")}
            </tr>
            <tr>
              <th>Contaminated Land:</th>
              ${cell({field:"contam_lan"}, true,"Y/N","")}
            </tr>
            <tr>
              <th>Stock Routes:</th>
              ${cell({field:"stk_route"}, true,"Y/N","")}
            </tr>
            <tr>
              <th>State Planning Policy:</th>
              ${cell({field:"state_plan_policy"}, true,"Copy from SPP viewer","")}
              <td><a href="https://spp.dsdip.esriaustraliaonline.com.au/spp" target="_blank" class="external-link">Open SPP</a></td>
            </tr>
            <tr>
              <th>Regional Plan:</th>
              ${cell({field:"regional_plan"}, true,"Copy from SARA viewer","")}
              <td><a href="https://sara.dsdip.esriaustraliaonline.com.au/saraviewer" target="_blank" class="external-link">Open Regional Plan</a></td>
            </tr>
            <tr>
              <th>Vegetation:</th>
              ${cell({field:"veg_mgmt_cat"}, true,"List categories","")}
            </tr>
            <tr>
              <th>Flood Hazard:</th>
              ${cell({field:"flooding"}, true,"Describe flood","")}
            </tr>
            <tr>
              <th>Bushfire Hazard:</th>
              ${cell({field:"bushfire"}, true,"Describe bushfire","")}
            </tr>
          </table>`;

        // 5. Social & Cultural
        html += `<div class="section-title">üèõÔ∏è Social & Cultural</div>
          <table>
            <tr>
              <th>Indigenous Cultural Heritage:</th>
              ${cell({field:"ind_cul_he"}, true,"Y/N","")}
            </tr>
            <tr>
              <th>CHMP:</th>
              ${cell({field:"cul_mgmt_plan"}, true,"Y/N + details","")}
            </tr>
          </table>`;

        // 6. Native Title
        html += `<div class="section-title">‚öñÔ∏è Native Title</div>
          <table>
            <tr>
              <th>NT Determination:</th>
              ${cell({field:"nt_determin"}, true,"Paste determination","")}
            </tr>
            <tr>
              <th>NT Status:</th>
              ${cell({field:"nt_status"}, true,"Describe status","")}
            </tr>
          </table>`;

        // 7. Planning Scheme
        html += `<div class="section-title">üèòÔ∏è Planning Scheme</div>
          <table>
            <tr>
              <th>Local Zoning:</th>
              ${cell({field:"plan_schem"}, true,"Enter zoning","")}
            </tr>
          </table>`;

        // 8. Consultation
        html += `<div class="section-title">ü§ù Consultation</div>
          <table>
            <tr>
              <th>Stakeholder Views:</th>
              ${cell({field:"sh_v_summ"}, true,"Summarise views","")}
            </tr>
          </table>`;

        // 9. Recommendations
        html += `<div class="section-title">‚úÖ Recommendations</div>
          <table>
            <tr>
              <th>Recommendations:</th>
              ${cell({field:"eval_summ"}, true,"Enter recommendations","")}
            </tr>
          </table>`;

        document.getElementById("formContent").innerHTML = html;
      }

      function saveEdits() {
        const edits = {}, divs = document.querySelectorAll(".editable");
        divs.forEach(d => {
          edits[d.dataset.field] = d.innerText.trim();
        });
        parcelsLayer.applyEdits({
          update: [{ attributes: { objectid: currentFeat.attributes.objectid, ...edits } }]
        }).then(() => alert("‚úÖ Saved successfully"))
          .catch(err => alert("‚ùå Save failed: "+err.message));
      }

      function generateReport() {
        // simple modal or console output; for demo just alert
        alert("üìÑ Report function triggered ‚Äî placeholder for full report export.");
      }

    }); // require
  </script>
</body>
</html>
