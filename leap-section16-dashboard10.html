<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LEAP Section 16 Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <style>
    html, body, #container { margin:0; padding:0; height:100%; }
    #container { display:flex; font-family:Arial,sans-serif; }
    #mapPane { position:relative; flex:1; }
    #viewDiv { width:100%; height:100%; }
    #infoPane { width:380px; background:#f5f5f5; overflow-y:auto; padding:20px; box-sizing:border-box; }
    #infoPane h2 { margin-top:0; color:#003087; }
    #infoPane h3 { margin:16px 0 8px; font-size:1.1em; font-weight:normal; color:#003087; }
    .assessment-table { width:100%; border-collapse:collapse; }
    .assessment-table th { text-align:left; padding:4px 8px; vertical-align:top; font-weight:normal; }
    .assessment-table td { padding:4px 8px; vertical-align:top; }
    .assessment-table input,.assessment-table textarea { width:100%; box-sizing:border-box; padding:4px; font-size:0.9em; border:1px solid #ccc; border-radius:3px; }
    .assessment-table textarea { resize:vertical; height:60px; }
    .btn { background:#003087; color:white; border:none; padding:6px 12px; border-radius:3px; cursor:pointer; margin-right:8px; }
    .btn:disabled { background:#aaa; cursor:not-allowed; }
    #status { position:absolute; left:10px; bottom:10px; background:#0008; color:#fff; padding:6px 10px; border-radius:8px; font-size:12px; display:none; }
  </style>
</head>
<body>
  <div id="container">
    <div id="mapPane">
      <div id="viewDiv"></div>
      <div id="status"></div>
    </div>
    <div id="infoPane">
      <h2>Section 16 Assessment</h2>
      <p id="startHint">Select a parcel on the map or search a Lot/Plan to begin.</p>

      <div id="formFields" style="display:none;">
        <h3>Parcel Details</h3>
        <table class="assessment-table">
          <tr><th>Lot/Plan</th>                 <td><input id="lotplan"     disabled /></td></tr>
          <tr><th>Lot</th>                      <td><input id="lot"         disabled /></td></tr>
          <tr><th>Plan</th>                     <td><input id="plan"        disabled /></td></tr>
          <tr><th>Survey Indicator</th>         <td><input id="surv_ind"    disabled /></td></tr>
          <tr><th>Title Reference</th>          <td><input id="title_ref"             /></td></tr>
          <tr><th>Property Address</th>         <td><input id="prop_addr"             /></td></tr>
          <tr><th>Area (ha)</th>                <td><input id="lot_area_c"            /></td></tr>
          <tr><th>Tenure</th>                   <td><input id="tenure"       disabled /></td></tr>
          <tr><th>Registered Owner/Trustee</th> <td><input id="reg_owner"            /></td></tr>
          <tr><th>Local Government Area</th>    <td><input id="shire_name"   disabled /></td></tr>
        </table>

        <h3>Administrative Attributes</h3>
        <table class="assessment-table">
          <tr><th>Access (Legal)</th>       <td><input id="access_l"    /></td></tr>
          <tr><th>Access (Practical)</th>   <td><input id="access_p"    /></td></tr>
          <tr><th>Registered Interests</th> <td><input id="ciram_chk"   /></td></tr>
          <tr><th>Current Valuation</th>    <td><input id="qvas_val"    /></td></tr>
          <tr><th>eLVAS Cases</th>          <td><input id="elvas_ref"   /></td></tr>
        </table>

        <h3>Site History & Background</h3>
        <table class="assessment-table">
          <tr><th>Native Title Status</th>      <td><input id="nt_status"      /></td></tr>
          <tr><th>Indigenous Cult Heritage</th> <td><input id="ind_cul_he"     /></td></tr>
          <tr><th>Qld Cult Heritage</th>        <td><input id="qld_cul_he"     /></td></tr>
          <tr><th>Historical Tenure</th>        <td><input id="ten_hist"       /></td></tr>
        </table>

        <h3>Physical, Biological & Economic</h3>
        <table class="assessment-table">
          <tr><th>Parcel Type</th>    <td><input id="parcel_typ"         /></td></tr>
          <tr><th>Cover Type</th>     <td><input id="cover_typ"          /></td></tr>
          <tr><th>Plan Constraints</th><td><textarea id="plan_const"></textarea></td></tr>
          <tr><th>MAUT Use</th>       <td><input id="mau"                /></td></tr>
          <tr><th>Past Material</th>  <td><input id="p_mat"              /></td></tr>
          <tr><th>Mining Interest</th><td><input id="mine_int"           /></td></tr>
          <tr><th>EPM App/Grant</th>  <td>
            <input id="epm_app" /><br/>
            <input id="epm_granted" placeholder="Granted" />
          </td></tr>
          <tr><th>ML Permit App/Grant</th><td>
            <input id="ml_permit_app" /><br/>
            <input id="ml_granted" placeholder="Granted" />
          </td></tr>
          <tr><th>Exploration Permit</th> <td><input id="appln_int"      /></td></tr>
        </table>

        <h3>Environment & Planning</h3>
        <table class="assessment-table">
          <tr><th>Contaminated Land</th>  <td><input id="contam_lan"     /></td></tr>
          <tr><th>Stock Route</th>        <td><input id="stk_route"      /></td></tr>
          <tr><th>State Plan Policy</th>  <td><input id="plan_schem"     /></td></tr>
          <tr><th>Regional Plan</th>      <td><textarea id="regional_plan"></textarea></td></tr>
          <tr><th>Flood Hazard</th>       <td><input id="flooding"       /></td></tr>
          <tr><th>Bushfire Hazard</th>    <td><input id="bushfire"       /></td></tr>
          <tr><th>Coastal Management</th> <td><input id="coastal_mgmt"   /></td></tr>
          <tr><th>Veg Mgmt Categories</th><td><input id="veg_mgmt_cat"   /></td></tr>
          <tr><th>Veg Mgmt Reg Ecos</th>  <td><input id="veg_mgmt_reg_eco"/></td></tr>
        </table>

        <h3>Social & Cultural Attributes</h3>
        <table class="assessment-table">
          <tr><th>Heritage Mgmt Plan</th><td><textarea id="cul_mgmt_plan"></textarea></td></tr>
          <tr><th>Study Area Bdy</th>    <td><textarea id="cul_studyarea_bdy"></textarea></td></tr>
          <tr><th>Party</th>            <td><input id="cul_party" /></td></tr>
        </table>

        <div style="margin-top:12px; text-align:right;">
          <button id="saveBtn" class="btn" disabled>ðŸ’¾ Save</button>
          <button id="reportBtn" class="btn" disabled>ðŸ“„ Report</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://js.arcgis.com/4.29/"></script>
  <script>
    require([
      "esri/config",
      "esri/identity/IdentityManager",
      "esri/portal/Portal",
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/layers/GraphicsLayer",
      "esri/Graphic",
      "esri/widgets/Zoom",
      "esri/widgets/Search"
    ], function(esriConfig, esriId, Portal, Map, MapView, FeatureLayer, GraphicsLayer, Graphic, Zoom, Search) {

      // === EDIT THESE TWO ===
      const PORTAL_URL = "https://uat-qportal.information.qld.gov.au/portal";
      const CLAIM_URL  = "https://uat-qportal.information.qld.gov.au/arcgis/rest/services/IDI/LEAP_ClaimParcels_new/FeatureServer/0";

      // Trust/CORS for server
      try {
        const { protocol, host } = new URL(CLAIM_URL);
        esriConfig.request.trustedServers.push(`${protocol}//${host}`);
        esriConfig.request.corsEnabledServers.push(host);
      } catch(e){}

      // Helper: status toast
      const status = document.getElementById("status");
      const toast = (t, show=true)=>{ status.textContent=t||""; status.style.display=show?"block":"none"; };

      // 0) Make sure we are signed in to the portal (so secured layers draw)
      esriConfig.portalUrl = PORTAL_URL;
      toast("Checking Portal sign-inâ€¦");
      esriId.checkSignInStatus(PORTAL_URL + "/sharing")
        .catch(() => esriId.signIn(PORTAL_URL + "/sharing"))
        .finally(initApp);

      function initApp(){
        toast("Loading mapâ€¦");

        // 1) map & view
        const map = new Map({ basemap: "satellite" });
        const view = new MapView({ container: "viewDiv", map, zoom: 6, center: [145, -24] });

        // 2) layers
        const claimLayer    = new FeatureLayer({ url: CLAIM_URL, outFields:["*"], popupEnabled:false });
        const highlightLayer= new GraphicsLayer();
        map.addMany([claimLayer, highlightLayer]);

        claimLayer.when(() => {
          toast("");
          if (claimLayer.fullExtent) view.goTo(claimLayer.fullExtent).catch(()=>{});
        }).catch(err => {
          console.error("Parcels layer failed:", err);
          toast("Layer failed. Check URL (/FeatureServer/0), sharing, or your login.");
        });

        // 3) zoom widget
        view.when(() => { view.ui.remove("zoom"); view.ui.add(new Zoom({ view }), "top-left"); });

        // 4) search by lotplan (update field name if needed)
        const search = new Search({
          view, includeDefaultSources:false,
          sources:[{ layer: claimLayer, searchFields:["lotplan"], displayField:"lotplan",
                     exactMatch:false, outFields:["*"], name:"Claim Parcels",
                     placeholder:"e.g. 45SP164230", resultGraphicEnabled:false, autoNavigate:true }]
        });
        view.ui.add(search, "top-right");

        // ===== selection + form =====
        const startHint  = document.getElementById("startHint");
        const formFields = document.getElementById("formFields");
        const saveBtn    = document.getElementById("saveBtn");
        const reportBtn  = document.getElementById("reportBtn");
        let selectedFeature = null;

        function clearSelection(){
          highlightLayer.removeAll();
          selectedFeature = null;
          startHint.style.display = "block";
          formFields.style.display= "none";
          saveBtn.disabled = reportBtn.disabled = true;
        }

        function showForm(feature){
          selectedFeature = feature;
          Object.entries(feature.attributes).forEach(([k,v])=>{
            const inp = document.getElementById(k);
            if (!inp) return;
            if (k==="lot_area" && v!=null) v = (v/10000).toFixed(3);
            inp.value = v!=null ? v : "";
          });
          startHint.style.display = "none";
          formFields.style.display= "block";
          saveBtn.disabled = reportBtn.disabled = false;
        }

        function highlightAndZoom(feature){
          highlightLayer.removeAll();
          highlightLayer.add(new Graphic({
            geometry: feature.geometry,
            symbol: { type:"simple-fill", color:[255,255,0,0.3], outline:{ color:"yellow", width:2 } }
          }));
          const padded = feature.geometry.extent ? feature.geometry.extent.expand(1.2) : feature.geometry;
          view.goTo(padded).catch(()=>{});
        }

        view.on("click", (evt)=>{
          view.hitTest(evt).then((r)=>{
            const hit = r.results.find(x=>x.graphic?.layer===claimLayer);
            if (hit){ showForm(hit.graphic); highlightAndZoom(hit.graphic); }
            else { clearSelection(); }
          });
        });

        search.on("select-result", (evt)=>{
          const feature = evt.result?.feature;
          if (feature){ showForm(feature); highlightAndZoom(feature); }
        });

        // Save (updates current feature)
        saveBtn.onclick = ()=>{
          if (!selectedFeature) return;
          const upd = { ...selectedFeature.attributes };
          Object.keys(upd).forEach(k=>{
            const inp = document.getElementById(k);
            if (inp && !inp.disabled) upd[k] = inp.value;
          });
          claimLayer.applyEdits({ updateFeatures:[{ attributes: upd }] })
            .then(r => {
              const ok = r.updateFeatureResults?.[0]?.success;
              alert(ok ? "âœ… Saved!" : "âŒ Save failed.");
            })
            .catch(e => alert("âŒ Save error: " + e.message));
        };

        reportBtn.onclick = ()=> alert("ðŸš§ Generate PDF here");

        clearSelection();
      }
    });
  </script>
</body>
</html>
