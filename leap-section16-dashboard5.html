<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>LEAP Section‚ÄØ16 Dashboard</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f5f5f5; }
    .header { background: linear-gradient(135deg,#003087,#0066cc); color:#fff; padding:15px; text-align:center; }
    .header h1 { margin:0; font-size:2em; }
    .main { display:grid; grid-template-columns:1fr 1.1fr; height:calc(100vh - 65px); }
    #mapView { width:100%; height:100%; }
    .rightPanel { background:#fff; overflow-y:auto; padding:20px; box-shadow:-2px 0 5px rgba(0,0,0,0.1); }
    .section-title { color:#003087; margin-top:20px; margin-bottom:10px; font-size:1.2em; border-bottom:2px solid #e9ecef; padding-bottom:5px; }
    table { width:100%; border-collapse:collapse; margin-bottom:15px; }
    th,td { padding:8px; border:1px solid #ddd; vertical-align:top; }
    th { width:35%; background:#e9ecef; }
    .readonly { background:#f0f0f0; }
    .editable { background:#fff; border:1px dashed #ccc; padding:4px; border-radius:4px; min-height:20px; }
    .editable:focus { outline:none; border-color:#003087; background:#f0f8ff; }
    .external-link { color:#28a745; text-decoration:none; font-size:0.85em; margin-left:5px; }
    .external-link:hover { text-decoration:underline; }
    .btn { background:#003087; color:#fff; border:none; padding:8px 14px; border-radius:4px; cursor:pointer; margin-right:5px; }
    .btn:hover { background:#0066cc; }
    .btn.small { padding:6px 10px; font-size:0.9em; }
    .hint { color:#856404; font-size:0.85em; }
    #searchDiv { display:flex; gap:8px; padding:10px; background:#fff; margin-bottom:10px; }
    #searchDiv input { flex:1; padding:6px; border:1px solid #ccc; border-radius:4px; }
  </style>
  <script src="https://js.arcgis.com/4.28/"></script>
</head>
<body>
  <div class="header">
    <h1>üèõÔ∏è LEAP Section‚ÄØ16 Dashboard</h1>
  </div>
  <div class="main">
    <div id="mapView"></div>
    <div class="rightPanel">
      <div id="searchDiv">
        <input id="lotSearch" type="text" placeholder="Search Lot/Plan (e.g. 45 on SP164230)" />
        <button id="lotSearchBtn" class="btn small">Search</button>
      </div>
      <div id="parcelSummary">
        <p><em>Select a parcel on the map or search above</em></p>
      </div>
      <div id="formContent"></div>
      <div style="text-align:center; margin:20px 0;">
        <button class="btn" id="saveBtn">üíæ Save</button>
        <button class="btn" id="reportBtn">üìÑ Generate Report</button>
      </div>
    </div>
  </div>

  <script>
    require([
      "esri/Map", "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/widgets/Search",
      "esri/identity/IdentityManager"
    ], function(Map, MapView, FeatureLayer, Search, esriId) {

      const LEAP_SERVICE = "https://uat-qportal.information.qld.gov.au/arcgis/rest/services/sirrte_idi_LEAP_ClaimParcels_vegtest/MapServer/1";
      let view, parcelsLayer, currentFeat, highlightHandle, layerViewPromise, searchWidget;

      esriId.getCredential(LEAP_SERVICE)
        .then(cred => initDashboard(cred.token))
        .catch(() => initDashboard());

      function initDashboard(token) {
        const map = new Map({ basemap: "satellite" });
        view = new MapView({
          container: "mapView",
          map,
          center: [152.7, -27.3],
          zoom: 8
        });

        parcelsLayer = new FeatureLayer({
          url: LEAP_SERVICE,
          outFields: ["*"],
          popupEnabled: false,
          customParameters: token ? { token } : null
        });
        map.add(parcelsLayer);

        // wait for layer view
        layerViewPromise = view.whenLayerView(parcelsLayer);

        // ArcGIS Search widget (hidden UI)
        searchWidget = new Search({
          view,
          allSources: [{
            layer: parcelsLayer,
            searchFields: ["lotplan"],
            displayField: "lotplan",
            exactMatch: false,
            outFields: ["*"],
            name: "Lot/Plan Search",
            placeholder: "e.g. 45 on SP164230"
          }]
        });
        view.ui.add(searchWidget, { position: "top-left", index: 0 });

        // button triggers search
        document.getElementById("lotSearchBtn").addEventListener("click", () => {
          const val = document.getElementById("lotSearch").value;
          if (val) {
            searchWidget.search(val);
          }
        });

        // when a search result is selected
        searchWidget.on("select-result", evt => {
          if (evt.result && evt.result.feature) {
            selectParcel(evt.result.feature);
          }
        });

        // map click selects
        view.on("click", event => {
          view.hitTest(event).then(response => {
            const hit = response.results.find(r => r.graphic.layer === parcelsLayer);
            if (hit) {
              selectParcel(hit.graphic);
            }
          });
        });

        // Save & Report
        document.getElementById("saveBtn").addEventListener("click", saveEdits);
        document.getElementById("reportBtn").addEventListener("click", generateReport);
      }

      function selectParcel(graphic) {
        currentFeat = graphic;
        const a = graphic.attributes;

        // highlight
        layerViewPromise.then(layerView => {
          if (highlightHandle) highlightHandle.remove();
          highlightHandle = layerView.highlight(a.objectid);
        });

        // zoom to parcel
        const geom = graphic.geometry;
        const ext = geom.extent.expand(1.2);
        view.goTo(ext);

        // summary
        document.getElementById("parcelSummary").innerHTML = `
          <h3>üìç ${a.lotplan || "Unknown"}</h3>
          <p><strong>Owner:</strong> ${a.claim_n || "Unknown"}</p>
          <p><strong>Area:</strong> ${a.lot_area ? (a.lot_area/10000).toFixed(2) + "‚ÄØha" : "Unknown"}</p>
        `;

        // build form
        buildForm(a);
      }

      function buildForm(f) {
        const cell = (fld, editable, placeholder="", hint="") => `
          <td class="${editable? "" : "readonly"}">
            ${editable
              ? `<div class="editable" contenteditable="true" data-field="${fld}" placeholder="${placeholder}">${f[fld]||""}</div>`
              : (f[fld]!==null?f[fld]:"")
            }
            ${hint? `<div class="hint">${hint}</div>` : ""}
          </td>`;

        let html = "";

        // Parcel Details
        html += `<div class="section-title">üìã Parcel Details</div>
          <table>
            <tr><th>Lot/Plan:</th>${cell("lotplan", false)}</tr>
            <tr><th>Title Reference:</th>${cell("title_ref", true,"Enter title ref","Confirm via QVAS")}</tr>
            <tr><th>Property Address:</th>${cell("prop_addr", true,"Enter address","")}</tr>
            <tr><th>Area (ha):</th>${cell("lot_area", false)}</tr>
            <tr><th>Tenure:</th>${cell("tenure", false)}</tr>
            <tr><th>Registered Trustee:</th>${cell("reg_owner", true,"Enter trustee","")}</tr>
            <tr><th>LGA:</th>${cell("shire_name", false)}</tr>
          </table>`;

        // Administrative
        html += `<div class="section-title">üîß Administrative Attributes</div>
          <table>
            <tr><th>Access:</th>${cell("access_l", true,"Describe access","")}</tr>
            <tr><th>Survey Requirements:</th>${cell("surv_ind", true,"Y/N","")}</tr>
            <tr><th>Registered Interests:</th>${cell("all_dis_re", true,"List easements","")}</tr>
            <tr>
              <th>Current Valuation:</th>
              ${cell("qvas_val", true,"Enter $ val","Use QVAS if unknown")}
            </tr>
            <tr><th>eLVAS & File Check:</th>${cell("elvas_ref", true,"File note refs","")}</tr>
          </table>`;

        // ... continue building all sections exactly as before ...

        document.getElementById("formContent").innerHTML = html;
      }

      function saveEdits() {
        if (!currentFeat) { alert("Select a parcel first"); return; }
        const edits = {}, divs = document.querySelectorAll(".editable");
        divs.forEach(d => edits[d.dataset.field] = d.innerText.trim());
        parcelsLayer.applyEdits({
          update: [{ attributes: Object.assign({ objectid: currentFeat.attributes.objectid }, edits) }]
        })
        .then(() => alert("‚úÖ Saved"))
        .catch(e => alert("‚ùå Save failed: " + e.message));
      }

      function generateReport() {
        if (!currentFeat) { alert("Select a parcel first"); return; }
        alert("üìÑ Report generation not yet implemented in this demo.");
      }

    }); // require
  </script>
</body>
</html>
