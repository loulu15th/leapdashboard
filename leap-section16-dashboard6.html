<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>LEAP Section¬†16 Dashboard</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#f5f5f5; }
    .header { background:linear-gradient(135deg,#003087,#0066cc); color:#fff; padding:15px; text-align:center; }
    .header h1 { margin:0; font-size:1.8em; }
    .main { display:grid; grid-template-columns:1fr 1.1fr; height:calc(100vh - 56px); }
    #mapView { width:100%; height:100%; }
    .panel { background:#fff; overflow-y:auto; padding:15px; box-shadow:-2px 0 5px rgba(0,0,0,0.1); }
    #searchBar { display:flex; gap:8px; margin-bottom:12px; }
    #searchBar input { flex:1; padding:6px; border:1px solid #ccc; border-radius:4px; }
    #searchBar button { padding:6px 12px; background:#003087; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    #searchBar button:hover { background:#005bb5; }
    .section-title { margin:20px 0 8px; font-size:1.1em; color:#003087; border-bottom:2px solid #e9ecef; padding-bottom:4px; }
    table { width:100%; border-collapse:collapse; margin-bottom:15px; }
    th,td { padding:8px; border:1px solid #ddd; vertical-align:top; }
    th { width:35%; background:#f0f0f0; text-align:left; }
    .readonly { background:#f9f9f9; }
    .editable { background:#fff; border:1px dashed #ccc; padding:4px; border-radius:4px; min-height:18px; }
    .editable:focus { outline:none; border-color:#003087; background:#f0f8ff; }
    .btn { padding:8px 14px; margin-right:8px; background:#003087; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    .btn:hover { background:#005bb5; }
    .hint { font-size:0.85em; color:#856404; margin-top:4px; }
  </style>
  <script src="https://js.arcgis.com/4.28/"></script>
</head>
<body>
  <div class="header"><h1>üèõÔ∏è LEAP Section¬†16 Dashboard</h1></div>
  <div class="main">
    <div id="mapView"></div>
    <div class="panel">
      <div id="searchBar">
        <input id="lotInput" type="text" placeholder="Enter Lot/Plan (e.g.¬†45 on¬†SP164230)" />
        <button id="btnSearch">Search</button>
      </div>
      <div id="parcelSummary"><em>Select a parcel via click or search above</em></div>
      <div id="formArea"></div>
      <div style="text-align:center; margin:20px 0;">
        <button id="btnSave" class="btn">üíæ Save</button>
        <button id="btnReport" class="btn">üìÑ Generate Report</button>
      </div>
    </div>
  </div>

<script>
require([
  "esri/Map","esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/identity/IdentityManager"
], function(Map, MapView, FeatureLayer, IdentityManager) {

  const LEAP_SERVICE = "https://uat‚Äëqportal.information.qld.gov.au/.../ClaimParcels_vegtest/1";
  let view, parcelsLayer, layerView, highlightHandle, currentGraphic;

  // get credential if needed
  IdentityManager.getCredential(LEAP_SERVICE)
    .then(cred => init(cred.token))
    .catch(() => init());

  function init(token) {
    view = new MapView({
      container: "mapView",
      map: new Map({ basemap: "satellite" }),
      center: [152.7, -27.3],
      zoom: 8
    });

    parcelsLayer = new FeatureLayer({
      url: LEAP_SERVICE,
      outFields: ["*"],
      customParameters: token ? { token } : null
    });
    view.map.add(parcelsLayer);

    // store layerView for highlight() and editingEnabled check
    view.whenLayerView(parcelsLayer).then(lv => layerView = lv);

    // map‚Äëclick: select or deselect
    view.on("click", e => {
      view.hitTest(e).then(res => {
        const hit = res.results.find(r => r.graphic.layer === parcelsLayer);
        if (hit) {
          selectParcel(hit.graphic);
        } else {
          clearSelection();
        }
      });
    });

    // wire up your external search box
    document.getElementById("btnSearch").onclick = doSearch;
    document.getElementById("lotInput").addEventListener("keyup", ev => {
      if (ev.key === "Enter") doSearch();
    });

    // hide buttons until parcel selected
    toggleButtons(false);
    document.getElementById("btnSave").onclick = saveEdits;
    document.getElementById("btnReport").onclick = () => alert("Report stub");
  }

  function doSearch() {
    const txt = document.getElementById("lotInput").value.trim();
    if (!txt) return alert("Type a Lot/Plan");
    // case‚Äëinsensitive query
    const where = `UPPER(lotplan) = '${txt.toUpperCase().replace(/'/g,"''")}'`;
    parcelsLayer.queryFeatures({ where, outFields:["*"], returnGeometry:true })
      .then(res => {
        if (res.features.length) selectParcel(res.features[0]);
        else alert("No parcel found");
      })
      .catch(err => console.error(err));
  }

  function selectParcel(graphic) {
    currentGraphic = graphic;
    const a = graphic.attributes;

    // highlight
    if (highlightHandle) highlightHandle.remove();
    highlightHandle = layerView.highlight(graphic);

    // zoom
    view.goTo(graphic.geometry.extent.expand(1.2));

    // render summary & form
    document.getElementById("parcelSummary").innerHTML =
      `<h3>üìç ${a.lotplan}</h3>
       <p><strong>Owner:</strong> ${a.claim_n||"N/A"}</p>
       <p><strong>Area:</strong> ${a.lot_area?/10000+"‚ÄØha":"N/A"}</p>`;

    buildForm(a);
    toggleButtons(true);
  }

  function clearSelection() {
    currentGraphic = null;
    if (highlightHandle) highlightHandle.remove();
    document.getElementById("parcelSummary").innerHTML =
      `<em>Select a parcel via click or search</em>`;
    document.getElementById("formArea").innerHTML = "";
    toggleButtons(false);
  }

  function toggleButtons(show) {
    const disp = show ? "inline‚Äëblock" : "none";
    document.getElementById("btnSave").style.display = disp;
    document.getElementById("btnReport").style.display = disp;
  }

  function buildForm(attrs) {
    // same mkCell helper as before‚Ä¶
    const mkCell = (fld, editable, placeholder="", hint="") => {
      const val = attrs[fld]||"";
      if (!editable) return `<td class="readonly">${val}</td>`;
      return `<td>
        <div class="editable" contenteditable="true" data-field="${fld}"
             placeholder="${placeholder}">${val}</div>
        ${hint?`<div class="hint">${hint}</div>`:""}
      </td>`;
    };

    let html = "";
    html += `<div class="section-title">üìã Parcel Details</div>
      <table>
        <tr><th>Lot/Plan:</th>${mkCell("lotplan",false)}</tr>
        <!-- ‚Ä¶ other fields ‚Ä¶ -->
      </table>`;
    // build other sections‚Ä¶
    document.getElementById("formArea").innerHTML = html;
  }

  function saveEdits() {
    if (!currentGraphic) return;
    if (!layerView.editingEnabled) {
      return alert("‚ùå Layer is not editable on the server. Ask your admin to enable edits.");
    }
    const updates = { attributes: { objectid: currentGraphic.attributes.objectid }};
    document.querySelectorAll(".editable").forEach(el => {
      updates.attributes[el.dataset.field] = el.innerText.trim();
    });
    parcelsLayer.applyEdits({ update:[updates.attributes] })
      .then(() => alert("‚úÖ Saved"))
      .catch(err => alert("‚ùå Save failed: " + err.message));
  }

});
</script>
</body>
</html>
