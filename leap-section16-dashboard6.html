<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LEAP Section 16 Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- ArcGIS CSS -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
  <style>
    html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
    #container { display: flex; height:100%; }
    #mapPane { position:relative; flex:1; }
    #viewDiv { width:100%; height:100%; }
    /* Search box */
    #searchBox {
      position:absolute; top:10px; left:10px;
      background:white; padding:6px; border-radius:4px;
      box-shadow:0 1px 4px rgba(0,0,0,0.3);
      z-index: 99;
    }
    #searchBox input { width:200px; padding:4px; }
    /* Right pane */
    #infoPane {
      width:400px; max-width:40%;
      overflow-y:auto; background:#f5f5f5;
      padding:20px; box-sizing:border-box;
    }
    h2 { margin-top:0; color:#003087; }
    .field-row { margin-bottom:12px; }
    .field-row label { display:block; font-weight:bold; margin-bottom:4px; }
    .field-row input[type=text],
    .field-row textarea {
      width:100%; padding:6px; box-sizing:border-box;
      border:1px solid #ccc; border-radius:4px;
    }
    .field-row textarea { resize:vertical; height:60px; }
    .btn { background:#003087; color:white; border:none;
      padding:8px 16px; margin-right:8px; border-radius:4px;
      cursor:pointer; }
    .btn:disabled { background:#aaa; cursor:not-allowed; }
  </style>
</head>
<body>
  <div id="container">
    <div id="mapPane">
      <div id="viewDiv"></div>
      <div id="searchBox">
        <label for="lotplanInput">Search Lot/Plan:</label>
        <input id="lotplanInput" placeholder="e.g. 45SP164230">
        <button id="searchBtn" class="btn">Search</button>
      </div>
    </div>
    <div id="infoPane">
      <h2>Section 16 Assessment</h2>
      <p id="startHint">Select a parcel on the map or search a Lot/Plan to begin.</p>
      <div id="formFields" style="display:none;">
        <!-- Parcel Details -->
        <h3>Parcel Details</h3>
        <div class="field-row"><label>Lot/Plan</label><input id="f_lotplan" type="text" readonly></div>
        <div class="field-row"><label>Title Reference</label><input id="f_title_ref" type="text"></div>
        <div class="field-row"><label>Property Address</label><input id="f_prop_addr" type="text"></div>
        <div class="field-row"><label>Area (ha)</label><input id="f_lot_area_c" type="text"></div>
        <div class="field-row"><label>Tenure</label><input id="f_tenure" type="text" readonly></div>
        <div class="field-row"><label>Trustee</label><input id="f_reg_owner" type="text"></div>
        <div class="field-row"><label>LGA</label><input id="f_shire_name" type="text" readonly></div>

        <!-- Administrative Attributes -->
        <h3>Administrative Attributes</h3>
        <div class="field-row"><label>Access</label><input id="f_access_l" type="text"></div>
        <div class="field-row"><label>Survey Req'd</label><input id="f_surv_ind" type="text"></div>
        <div class="field-row"><label>Registered Interests</label><textarea id="f_elvas_ref"></textarea></div>
        <div class="field-row"><label>Valuation</label><input id="f_qvas_val" type="text" placeholder="Use QVAS"></div>

        <!-- You can continue adding the rest of your fields here in the same pattern… -->

        <div style="margin-top:20px;">
          <button id="saveBtn" class="btn" disabled>Save</button>
          <button id="reportBtn" class="btn" disabled>Generate Report</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ArcGIS JS API -->
  <script src="https://js.arcgis.com/4.29/"></script>
  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/Graphic",
      "esri/layers/GraphicsLayer",
      "esri/tasks/support/Query"
    ], function(Map, MapView, FeatureLayer, Graphic, GraphicsLayer, Query) {

      const CLAIM_URL = "https://uat-qportal.information.qld.gov.au/arcgis/rest/services/…/MapServer/1";

      // Base map & view
      const map = new Map({ basemap: "satellite" });
      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [152.7, -27.4],
        zoom: 6
      });

      // Claim parcels
      const claimLayer = new FeatureLayer({ url: CLAIM_URL, outFields: ["*"] });
      map.add(claimLayer);

      // Highlight graphics layer
      const highlightLayer = new GraphicsLayer();
      map.add(highlightLayer);

      // Form elements
      const form = document.getElementById("formFields");
      const hint = document.getElementById("startHint");
      const saveBtn = document.getElementById("saveBtn");
      const reportBtn = document.getElementById("reportBtn");

      // Input fields
      const inputs = {
        lotplan:     document.getElementById("f_lotplan"),
        title_ref:   document.getElementById("f_title_ref"),
        prop_addr:   document.getElementById("f_prop_addr"),
        lot_area_c:  document.getElementById("f_lot_area_c"),
        tenure:      document.getElementById("f_tenure"),
        reg_owner:   document.getElementById("f_reg_owner"),
        shire_name:  document.getElementById("f_shire_name"),
        access_l:    document.getElementById("f_access_l"),
        surv_ind:    document.getElementById("f_surv_ind"),
        elvas_ref:   document.getElementById("f_elvas_ref"),
        qvas_val:    document.getElementById("f_qvas_val")
        // …add more here…
      };

      let selectedFeature = null;

      // Utility: show/hide form
      function showForm(feature) {
        selectedFeature = feature;
        hint.style.display = "none";
        form.style.display = "block";
        saveBtn.disabled = false;
        reportBtn.disabled = false;

        const attr = feature.attributes;
        inputs.lotplan.value    = attr.lotplan || "";
        inputs.title_ref.value  = attr.title_ref || "";
        inputs.prop_addr.value  = attr.prop_addr || "";
        inputs.lot_area_c.value = attr.lot_area_c != null ? (attr.lot_area_c / 10000).toFixed(2) : "";
        inputs.tenure.value     = attr.tenure || "";
        inputs.reg_owner.value  = attr.reg_owner || "";
        inputs.shire_name.value = attr.shire_name || "";
        inputs.access_l.value   = attr.access_l || "";
        inputs.surv_ind.value   = attr.surv_ind || "";
        inputs.elvas_ref.value  = attr.elvas_ref || "";
        inputs.qvas_val.value   = attr.qvas_val != null ? attr.qvas_val : "";
      }

      function clearSelection() {
        selectedFeature = null;
        highlightLayer.removeAll();
        form.style.display = "none";
        hint.style.display = "block";
        saveBtn.disabled = true;
        reportBtn.disabled = true;
      }

      // Highlight + zoom
      function highlightAndZoom(feature) {
        highlightLayer.removeAll();
        const sym = claimLayer.renderer.getSymbol({ size: 0 });
        const highlightSym = sym.clone();
        highlightSym.outline = { color: [255,0,0], width:2 };
        const graphic = new Graphic({
          geometry: feature.geometry,
          symbol: highlightSym
        });
        highlightLayer.add(graphic);
        view.goTo({ target: feature.geometry, extent: feature.geometry.extent.expand(1.2) });
      }

      // Query by lotplan
      function queryByLotplan(lp) {
        const q = new Query();
        q.where = `UPPER(lotplan)='${lp.toUpperCase()}'`;
        q.returnGeometry = true;
        q.outFields = ["*"];
        return claimLayer.queryFeatures(q);
      }

      // Map click handler
      view.on("click", evt => {
        view.hitTest(evt).then(res => {
          const gr = res.results.find(r => r.graphic && r.graphic.layer === claimLayer);
          if (gr) {
            showForm(gr.graphic);
            highlightAndZoom(gr.graphic);
          } else {
            clearSelection();
          }
        });
      });

      // Search button click
      document.getElementById("searchBtn").onclick = () => {
        const lp = document.getElementById("lotplanInput").value.trim();
        if (!lp) return;
        queryByLotplan(lp).then(res => {
          if (res.features.length) {
            const feat = res.features[0];
            showForm(feat);
            highlightAndZoom(feat);
          } else {
            clearSelection();
            alert("No parcel found with that Lot/Plan.");
          }
        });
      };

      // Save (stub)
      saveBtn.onclick = () => {
        // collect edits into an applyEdits() if your service supports it
        alert("Save clicked – implement applyEdits here.");
      };

      // Generate report (stub)
      reportBtn.onclick = () => {
        alert("Generate Report clicked – assemble your template and open modal/pdf.");
      };

      // initial state
      clearSelection();
    });
  </script>
</body>
</html>
