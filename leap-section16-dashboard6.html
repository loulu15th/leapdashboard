
<script>
require([
  "esri/Map","esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/identity/IdentityManager"
], function(Map, MapView, FeatureLayer, IdentityManager) {

  const LEAP_SERVICE = "https://uat‚Äëqportal.information.qld.gov.au/.../ClaimParcels_vegtest/1";
  let view, parcelsLayer, layerView, highlightHandle, currentGraphic;

  // get credential if needed
  IdentityManager.getCredential(LEAP_SERVICE)
    .then(cred => init(cred.token))
    .catch(() => init());

  function init(token) {
    view = new MapView({
      container: "mapView",
      map: new Map({ basemap: "satellite" }),
      center: [152.7, -27.3],
      zoom: 8
    });

    parcelsLayer = new FeatureLayer({
      url: LEAP_SERVICE,
      outFields: ["*"],
      customParameters: token ? { token } : null
    });
    view.map.add(parcelsLayer);

    // store layerView for highlight() and editingEnabled check
    view.whenLayerView(parcelsLayer).then(lv => layerView = lv);

    // map‚Äëclick: select or deselect
    view.on("click", e => {
      view.hitTest(e).then(res => {
        const hit = res.results.find(r => r.graphic.layer === parcelsLayer);
        if (hit) {
          selectParcel(hit.graphic);
        } else {
          clearSelection();
        }
      });
    });

    // wire up your external search box
    document.getElementById("btnSearch").onclick = doSearch;
    document.getElementById("lotInput").addEventListener("keyup", ev => {
      if (ev.key === "Enter") doSearch();
    });

    // hide buttons until parcel selected
    toggleButtons(false);
    document.getElementById("btnSave").onclick = saveEdits;
    document.getElementById("btnReport").onclick = () => alert("Report stub");
  }

  function doSearch() {
    const txt = document.getElementById("lotInput").value.trim();
    if (!txt) return alert("Type a Lot/Plan");
    // case‚Äëinsensitive query
    const where = `UPPER(lotplan) = '${txt.toUpperCase().replace(/'/g,"''")}'`;
    parcelsLayer.queryFeatures({ where, outFields:["*"], returnGeometry:true })
      .then(res => {
        if (res.features.length) selectParcel(res.features[0]);
        else alert("No parcel found");
      })
      .catch(err => console.error(err));
  }

  function selectParcel(graphic) {
    currentGraphic = graphic;
    const a = graphic.attributes;

    // highlight
    if (highlightHandle) highlightHandle.remove();
    highlightHandle = layerView.highlight(graphic);

    // zoom
    view.goTo(graphic.geometry.extent.expand(1.2));

    // render summary & form
    document.getElementById("parcelSummary").innerHTML =
      `<h3>üìç ${a.lotplan}</h3>
       <p><strong>Owner:</strong> ${a.claim_n||"N/A"}</p>
       <p><strong>Area:</strong> ${a.lot_area?/10000+"‚ÄØha":"N/A"}</p>`;

    buildForm(a);
    toggleButtons(true);
  }

  function clearSelection() {
    currentGraphic = null;
    if (highlightHandle) highlightHandle.remove();
    document.getElementById("parcelSummary").innerHTML =
      `<em>Select a parcel via click or search</em>`;
    document.getElementById("formArea").innerHTML = "";
    toggleButtons(false);
  }

  function toggleButtons(show) {
    const disp = show ? "inline‚Äëblock" : "none";
    document.getElementById("btnSave").style.display = disp;
    document.getElementById("btnReport").style.display = disp;
  }

  function buildForm(attrs) {
    // same mkCell helper as before‚Ä¶
    const mkCell = (fld, editable, placeholder="", hint="") => {
      const val = attrs[fld]||"";
      if (!editable) return `<td class="readonly">${val}</td>`;
      return `<td>
        <div class="editable" contenteditable="true" data-field="${fld}"
             placeholder="${placeholder}">${val}</div>
        ${hint?`<div class="hint">${hint}</div>`:""}
      </td>`;
    };

    let html = "";
    html += `<div class="section-title">üìã Parcel Details</div>
      <table>
        <tr><th>Lot/Plan:</th>${mkCell("lotplan",false)}</tr>
        <!-- ‚Ä¶ other fields ‚Ä¶ -->
      </table>`;
    // build other sections‚Ä¶
    document.getElementById("formArea").innerHTML = html;
  }

  function saveEdits() {
    if (!currentGraphic) return;
    if (!layerView.editingEnabled) {
      return alert("‚ùå Layer is not editable on the server. Ask your admin to enable edits.");
    }
    const updates = { attributes: { objectid: currentGraphic.attributes.objectid }};
    document.querySelectorAll(".editable").forEach(el => {
      updates.attributes[el.dataset.field] = el.innerText.trim();
    });
    parcelsLayer.applyEdits({ update:[updates.attributes] })
      .then(() => alert("‚úÖ Saved"))
      .catch(err => alert("‚ùå Save failed: " + err.message));
  }

});
</script>
