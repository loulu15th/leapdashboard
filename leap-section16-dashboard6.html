<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LEAP Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>
  <style>
    html, body, #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #mainLayout {
      display: flex;
      height: 100%;
    }

    #viewDiv {
      flex: 2;
    }

    #formPanel {
      flex: 1;
      overflow-y: auto;
      padding: 1em;
      border-left: 1px solid #ccc;
      display: none;
    }

    .input-block {
      margin-bottom: 12px;
    }

    .input-block label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .input-block input, .input-block textarea {
      width: 100%;
      padding: 6px;
    }

    #searchBox {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 99;
      background: white;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      border-radius: 5px;
    }

    #saveButton, #generateReportButton {
      margin-top: 12px;
      padding: 10px;
      width: 100%;
      cursor: pointer;
    }

    #message {
      color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="mainLayout">
    <div id="viewDiv"></div>
    <div id="formPanel">
      <h3>Parcel Information</h3>
      <form id="attributesForm"></form>
      <button id="saveButton">Save</button>
      <button id="generateReportButton">Generate Report</button>
      <p id="message"></p>
    </div>
  </div>
  <div id="searchBox">
    <label for="lotplanInput"><strong>Search LotPlan:</strong></label>
    <input type="text" id="lotplanInput" list="lotplanSuggestions" placeholder="e.g. 45SP164230" />
    <datalist id="lotplanSuggestions"></datalist>
  </div>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/Graphic",
      "esri/tasks/support/Query"
    ], (Map, MapView, FeatureLayer, Graphic, Query) => {
      const uatLayerUrl = "https://services8.arcgis.com/N9pWXvW1bA4UHL2O/arcgis/rest/services/ClaimParcels_vegtest/FeatureServer/1";

      const layer = new FeatureLayer({
        url: uatLayerUrl,
        outFields: ["*"]
      });

      const map = new Map({
        basemap: "streets-vector",
        layers: [layer]
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [148, -23], // QLD center
        zoom: 6
      });

      let selectedFeature = null;

      // Autocomplete setup
      layer.queryFeatures({ where: "1=1", outFields: ["lotplan"], returnDistinctValues: true, returnGeometry: false })
        .then(result => {
          const list = document.getElementById("lotplanSuggestions");
          const lotplans = [...new Set(result.features.map(f => f.attributes.lotplan))];
          lotplans.forEach(lp => {
            if (lp) {
              const option = document.createElement("option");
              option.value = lp;
              list.appendChild(option);
            }
          });
        });

      document.getElementById("lotplanInput").addEventListener("change", (e) => {
        const input = e.target.value.trim().toUpperCase();
        if (!input) return;

        const query = layer.createQuery();
        query.where = `UPPER(lotplan) = '${input}'`;
        query.returnGeometry = true;
        query.outFields = ["*"];

        layer.queryFeatures(query).then(result => {
          if (result.features.length > 0) {
            const feature = result.features[0];
            view.goTo(feature.geometry.extent.expand(2));
            showAttributes(feature);
            highlightFeature(feature);
          }
        });
      });

      view.on("click", (event) => {
        view.hitTest(event).then(response => {
          const graphic = response.results.find(r => r.graphic.layer === layer)?.graphic;
          if (graphic) {
            showAttributes(graphic);
            highlightFeature(graphic);
          } else {
            selectedFeature = null;
            document.getElementById("formPanel").style.display = "none";
          }
        });
      });

      function highlightFeature(feature) {
        view.graphics.removeAll();
        const highlight = new Graphic({
          geometry: feature.geometry,
          symbol: {
            type: "simple-fill",
            color: [0, 0, 0, 0],
            outline: { color: "cyan", width: 3 }
          }
        });
        view.graphics.add(highlight);
      }

      function showAttributes(feature) {
        selectedFeature = feature;
        const form = document.getElementById("attributesForm");
        form.innerHTML = "";

        const fieldsToShow = ["lotplan", "claim_n", "access_l", "access_p", "shire_name", "tenure", "prop_addr", "title_ref", "qvas_val"];
        fieldsToShow.forEach(field => {
          const block = document.createElement("div");
          block.className = "input-block";

          const label = document.createElement("label");
          label.innerText = field;
          const input = document.createElement("input");
          input.value = feature.attributes[field] || "";
          input.id = field;
          input.dataset.field = field;

          block.appendChild(label);
          block.appendChild(input);
          form.appendChild(block);
        });

        document.getElementById("formPanel").style.display = "block";
      }

      document.getElementById("saveButton").addEventListener("click", () => {
        if (!selectedFeature) return;

        const updates = { ...selectedFeature.attributes };
        const inputs = document.querySelectorAll("#attributesForm input");
        inputs.forEach(input => {
          updates[input.dataset.field] = input.value;
        });

        const updatedGraphic = new Graphic({
          geometry: selectedFeature.geometry,
          attributes: updates
        });

        layer.applyEdits({ updateFeatures: [updatedGraphic] }).then(response => {
          document.getElementById("message").innerText = "✅ Saved successfully!";
          setTimeout(() => document.getElementById("message").innerText = "", 2000);
        }).catch(err => {
          console.error(err);
          document.getElementById("message").innerText = "❌ Failed to save.";
        });
      });

      document.getElementById("generateReportButton").addEventListener("click", () => {
        alert("Report generation will be implemented later.");
      });
    });
  </script>
</body>
</html>
