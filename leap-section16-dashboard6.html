<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LEAP Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>
  <style>
    html, body, #viewDiv {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial;
    }

    #mainLayout {
      display: flex;
      height: 100%;
    }

    #viewDiv {
      flex: 2;
    }

    #panel {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      border-left: 1px solid #ccc;
      display: none;
      background: #fff;
    }

    #searchContainer {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      z-index: 99;
      box-shadow: 0 0 5px #ccc;
      border-radius: 4px;
    }

    input {
      padding: 5px;
      width: 180px;
    }

    button {
      margin-top: 10px;
      padding: 10px;
    }

    label {
      font-weight: bold;
    }

    .field-group {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
<div id="mainLayout">
  <div id="viewDiv"></div>
  <div id="panel">
    <h3>Parcel Info</h3>
    <div id="formFields"></div>
    <button id="saveBtn">Save</button>
    <button id="reportBtn">Generate Report</button>
    <div id="msg"></div>
  </div>
</div>

<div id="searchContainer">
  <label for="lotplanInput">Search LotPlan:</label>
  <input id="lotplanInput" list="suggestions" placeholder="e.g. 45SP164230" />
  <datalist id="suggestions"></datalist>
</div>

<script>
require([
  "esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer", "esri/Graphic", "esri/tasks/support/Query"
], (Map, MapView, FeatureLayer, Graphic, Query) => {
  const layer = new FeatureLayer({
    url: "https://services8.arcgis.com/N9pWXvW1bA4UHL2O/arcgis/rest/services/ClaimParcels_vegtest/FeatureServer/1",
    outFields: ["*"],
    popupEnabled: false
  });

  const map = new Map({
    basemap: "satellite",
    layers: [layer]
  });

  const view = new MapView({
    container: "viewDiv",
    map: map,
    center: [148, -23],
    zoom: 6
  });

  let selected = null;

  // Fill datalist
  layer.queryFeatures({
    where: "1=1",
    outFields: ["lotplan"],
    returnDistinctValues: true,
    returnGeometry: false
  }).then(res => {
    const datalist = document.getElementById("suggestions");
    const lotplans = [...new Set(res.features.map(f => f.attributes.lotplan))];
    lotplans.forEach(lp => {
      if (lp) {
        const opt = document.createElement("option");
        opt.value = lp;
        datalist.appendChild(opt);
      }
    });
  });

  // Search by LotPlan
  document.getElementById("lotplanInput").addEventListener("change", e => {
    const input = e.target.value.trim().toUpperCase();
    if (!input) return;
    const q = layer.createQuery();
    q.where = `UPPER(lotplan) = '${input}'`;
    q.returnGeometry = true;
    q.outFields = ["*"];
    layer.queryFeatures(q).then(res => {
      if (res.features.length) {
        const feat = res.features[0];
        showForm(feat);
        zoomHighlight(feat);
      }
    });
  });

  // Map click
  view.on("click", evt => {
    view.hitTest(evt).then(resp => {
      const feat = resp.results.find(r => r.graphic.layer === layer)?.graphic;
      if (feat) {
        showForm(feat);
        zoomHighlight(feat);
      } else {
        selected = null;
        document.getElementById("panel").style.display = "none";
        view.graphics.removeAll();
      }
    });
  });

  function zoomHighlight(f) {
    view.graphics.removeAll();
    const g = new Graphic({
      geometry: f.geometry,
      symbol: {
        type: "simple-fill",
        color: [0, 0, 0, 0],
        outline: { color: "yellow", width: 2 }
      }
    });
    view.graphics.add(g);
    view.goTo(f.geometry.extent.expand(2));
  }

  function showForm(f) {
    selected = f;
    const container = document.getElementById("formFields");
    container.innerHTML = "";
    const editable = ["title_ref", "prop_addr", "tenure", "access_l", "access_p"];
    editable.forEach(field => {
      const div = document.createElement("div");
      div.className = "field-group";
      const lbl = document.createElement("label");
      lbl.innerText = field;
      const input = document.createElement("input");
      input.value = f.attributes[field] || "";
      input.id = field;
      div.appendChild(lbl);
      div.appendChild(input);
      container.appendChild(div);
    });
    document.getElementById("panel").style.display = "block";
  }

  document.getElementById("saveBtn").addEventListener("click", () => {
    if (!selected) return;
    const attrs = selected.attributes;
    ["title_ref", "prop_addr", "tenure", "access_l", "access_p"].forEach(id => {
      attrs[id] = document.getElementById(id).value;
    });
    const updated = new Graphic({ geometry: selected.geometry, attributes: attrs });
    layer.applyEdits({ updateFeatures: [updated] }).then(() => {
      document.getElementById("msg").innerText = "‚úÖ Saved!";
      setTimeout(() => document.getElementById("msg").innerText = "", 1500);
    });
  });

  document.getElementById("reportBtn").addEventListener("click", () => {
    alert("üìù Report generation coming soon.");
  });
});
</script>
</body>
</html>
