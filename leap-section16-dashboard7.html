<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LEAP SectionÂ 16 Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #container { display:flex; height:100%; font-family:Arial,sans-serif; }
    #mapPane { position:relative; flex:1; }
    #viewDiv { width:100%; height:100%; }
    #searchBox {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      padding: 8px;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      z-index: 99;
    }
    #searchBox input { width:160px; padding:4px; }
    #infoPane { width:380px; background:#f5f5f5; overflow-y:auto; padding:20px; box-sizing:border-box; }
    h2 { margin-top:0; color:#003087; }
    .assessment-table { width:100%; border-collapse:collapse; margin-bottom:16px; }
    .assessment-table th { text-align:left; padding:4px 8px; width:40%; vertical-align:top; }
    .assessment-table td { padding:4px 8px; }
    .assessment-table input { width:100%; padding:6px; box-sizing:border-box; border:1px solid #ccc; border-radius:4px; }
    .btn {
      background:#003087; color:white; border:none;
      padding:8px 16px; border-radius:4px;
      cursor:pointer; margin-right:8px;
    }
    .btn:disabled { background:#aaa; cursor:not-allowed; }
  </style>
</head>
<body>
  <div id="container">
    <div id="mapPane">
      <div id="viewDiv"></div>
      <div id="searchBox">
        <input id="lotplanInput" placeholder="Search Lot/Plan e.g. 45SP164230" />
        <button id="searchBtn" class="btn">Search</button>
      </div>
    </div>
    <div id="infoPane">
      <h2>SectionÂ 16 Assessment</h2>
      <p id="startHint">Select a parcel on the map or search a Lot/Plan to begin.</p>
      <div id="formFields" style="display:none;">
        <!-- Parcel Details -->
        <h3>Parcel Details</h3>
        <table class="assessment-table">
          <tr><th>Lot/Plan</th>                 <td><input id="lotplan"     disabled /></td></tr>
          <tr><th>Lot</th>                      <td><input id="lot"         disabled /></td></tr>
          <tr><th>Plan</th>                     <td><input id="plan"        disabled /></td></tr>
          <tr><th>SurveyÂ Indicator</th>         <td><input id="surv_ind"    disabled /></td></tr>
          <tr><th>TitleÂ Reference</th>          <td><input id="title_ref"             /></td></tr>
          <tr><th>PropertyÂ Address</th>         <td><input id="prop_addr"             /></td></tr>
          <tr><th>AreaÂ (ha)</th>                <td><input id="lot_area"             /></td></tr>
          <tr><th>Tenure</th>                   <td><input id="tenure"       disabled /></td></tr>
          <tr><th>RegisteredÂ Owner/Trustee</th> <td><input id="reg_owner"            /></td></tr>
          <tr><th>LocalÂ GovernmentÂ Area</th>    <td><input id="shire_name"   disabled /></td></tr>
        </table>
        <!-- Administrative Attributes -->
        <h3>AdministrativeÂ Attributes</h3>
        <table class="assessment-table">
          <tr><th>AccessÂ (Legal)</th>        <td><input id="access_l" /></td></tr>
          <tr><th>AccessÂ (Practical)</th>    <td><input id="access_p" /></td></tr>
          <tr><th>RegisteredÂ Interests</th>  <td><input id="ciram_chk" /></td></tr>
          <tr><th>QVASÂ Valuation</th>       <td><input id="qvas_val"  /></td></tr>
          <tr><th>eLVASÂ Cases</th>           <td><input id="elvas_ref" /></td></tr>
        </table>
        <!-- Site History & Background -->
        <h3>SiteÂ HistoryÂ &Â Background</h3>
        <table class="assessment-table">
          <tr><th>NativeÂ Title Status</th>      <td><input id="nt_status"  /></td></tr>
          <tr><th>IndigenousÂ CulturalÂ Heritage</th><td><input id="ind_cul_he" /></td></tr>
          <tr><th>QldÂ CulturalÂ Heritage</th>     <td><input id="qld_cul_he" /></td></tr>
          <tr><th>HistoricalÂ Tenure</th>        <td><input id="ten_hist"   /></td></tr>
        </table>
        <!-- Physical, Biological & Economic -->
        <h3>Physical, Biological & Economic</h3>
        <table class="assessment-table">
          <tr><th>ParcelÂ Type</th>       <td><input id="parcel_typ"     /></td></tr>
          <tr><th>CoverÂ Type</th>        <td><input id="cover_typ"      /></td></tr>
          <tr><th>PlanÂ Constraints</th>  <td><input id="plan_const"     /></td></tr>
          <tr><th>MAUTÂ Use</th>          <td><input id="mau"            /></td></tr>
          <tr><th>PastÂ Material</th>     <td><input id="p_mat"          /></td></tr>
          <tr><th>MiningÂ Interest</th>   <td><input id="mine_int"       /></td></tr>
          <tr><th>EPMÂ App / Granted</th> <td>
            <input id="epm_app" placeholder="Application" /><br/>
            <input id="epm_granted" placeholder="Granted" />
          </td></tr>
          <tr><th>MLÂ PermitÂ App / Granted</th><td>
            <input id="ml_permit_app" placeholder="Application" /><br/>
            <input id="ml_granted" placeholder="Granted" />
          </td></tr>
          <tr><th>Expl PermitÂ Code</th>  <td><input id="appln_int"      /></td></tr>
        </table>
        <!-- Environment & Planning -->
        <h3>Environment & Planning</h3>
        <table class="assessment-table">
          <tr><th>ContaminatedÂ Land</th>      <td><input id="contam_lan"    /></td></tr>
          <tr><th>StockÂ Route</th>            <td><input id="stk_route"     /></td></tr>
          <tr><th>State Plan Policy</th>      <td><input id="plan_schem"    /></td></tr>
          <tr><th>RegionalÂ Plan</th>          <td><input id="regional_plan" /></td></tr>
          <tr><th>FloodÂ Hazard</th>           <td><input id="flooding"      /></td></tr>
          <tr><th>BushfireÂ Hazard</th>        <td><input id="bushfire"      /></td></tr>
          <tr><th>CoastalÂ Mgmt</th>           <td><input id="coastal_mgmt"  /></td></tr>
          <tr><th>VegÂ MgmtÂ Categories</th>    <td><input id="veg_mgmt_cat"  /></td></tr>
          <tr><th>VegÂ MgmtÂ RegÂ Ecos</th>      <td><input id="veg_mgmt_reg_eco" /></td></tr>
        </table>
        <!-- Social & Cultural -->
        <h3>Social & Cultural Attributes</h3>
        <table class="assessment-table">
          <tr><th>HeritageÂ MgmtÂ Plan</th>  <td><input id="cul_mgmt_plan" /></td></tr>
          <tr><th>Study Area Bdy</th>      <td><input id="cul_studyarea_bdy" /></td></tr>
          <tr><th>Party</th>               <td><input id="cul_party" /></td></tr>
        </table>
        <div style="text-align:right; margin-top:12px;">
          <button id="saveBtn" class="btn" disabled>ðŸ’¾ Save</button>
          <button id="reportBtn" class="btn" disabled>ðŸ“„ Generate</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://js.arcgis.com/4.29/"></script>
  <script>
    require([
      "esri/config",
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/TileLayer",
      "esri/layers/FeatureLayer",
      "esri/layers/GraphicsLayer",
      "esri/Graphic",
      "esri/tasks/QueryTask",
      "esri/rest/support/Query"
    ], function(
      esriConfig, Map, MapView,
      TileLayer, FeatureLayer, GraphicsLayer,
      Graphic, QueryTask, Query
    ) {

      // Point to AGOL so basemaps load correctly
      esriConfig.portalUrl = "https://www.arcgis.com";

      const CLAIM_URL = 
        "https://uat-qportal.information.qld.gov.au/arcgis/rest/services/" +
        "sirrte_idi_LEAP_ClaimParcels_vegtest/MapServer/1";

      // 1) Build the map & view
      const map = new Map({ basemap: null });
      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [152.7, -27.3],
        zoom: 7
      });

      // 2) Add a known-working World Imagery layer
      const imagery = new TileLayer({
        title: "World Imagery",
        url: "https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"
      });
      map.add(imagery);

      // 3) Add your UAT parcel layer and an empty graphics layer for highlights
      const claimLayer = new FeatureLayer({
        url: CLAIM_URL,
        outFields: ["*"],
        popupEnabled: false
      });
      const highlightLayer = new GraphicsLayer();
      map.addMany([claimLayer, highlightLayer]);

      // --- UI elements
      const startHint  = document.getElementById("startHint");
      const formFields = document.getElementById("formFields");
      const saveBtn    = document.getElementById("saveBtn");
      const reportBtn  = document.getElementById("reportBtn");
      const lotplanIn  = document.getElementById("lotplanInput");

      let selectedFeature = null;

      // 4) clear everything
      function clearSelection() {
        highlightLayer.removeAll();
        selectedFeature = null;
        formFields.style.display = "none";
        startHint.style.display  = "block";
        saveBtn.disabled   = true;
        reportBtn.disabled = true;
      }

      // 5) Show the form and populate
      function showForm(graphic) {
        selectedFeature = graphic;
        const attrs = graphic.attributes;

        Object.keys(attrs).forEach(key => {
          const input = document.getElementById(key);
          if (!input) return;
          let val = attrs[key];

          // convert mÂ² to ha if needed
          if (key === "lot_area" && val != null) {
            val = (val/10000).toFixed(2);
          }
          input.value = val == null ? "" : val;
        });

        startHint.style.display = "none";
        formFields.style.display = "block";
        saveBtn.disabled   = false;
        reportBtn.disabled = false;
      }

      // 6) Highlight & zoom
      function highlightAndZoom(graphic) {
        highlightLayer.removeAll();
        const symbol = {
          type: "simple-fill",
          color: [0,0,0,0],
          outline: { color: [255,165,0], width: 3 }
        };
        const highlight = new Graphic({
          geometry: graphic.geometry,
          symbol: symbol
        });
        highlightLayer.add(highlight);
        view.goTo(graphic.geometry.extent.expand(1.5));
      }

      // 7) Query by lotplan string
      function queryByLotplan(lp) {
        const qt = new QueryTask({ url: CLAIM_URL });
        const q  = new Query({
          where: `lotplan='${lp.replace("'", "''")}'`,
          outFields: ["*"],
          returnGeometry: true
        });
        return qt.execute(q);
      }

      // 8) Wire up the search button
      document.getElementById("searchBtn")
        .addEventListener("click", () => {
          const txt = lotplanIn.value.trim();
          if (!txt) { return; }
          queryByLotplan(txt)
            .then(res => {
              if (res.features.length > 0) {
                const f = res.features[0];
                showForm(f);
                highlightAndZoom(f);
              } else {
                clearSelection();
                alert("No parcel found for: " + txt);
              }
            })
            .catch(err => {
              console.error(err);
              alert("Error searching parcels");
            });
        });

      // 9) Let users click on the map to select
      view.on("click", evt => {
        view.hitTest(evt).then(hit => {
          // find first result from our claim layer
          const match = hit.results.find(r => 
            r.graphic.layer === claimLayer
          );
          if (match) {
            const f = match.graphic.clone();
            showForm(f);
            highlightAndZoom(f);
          } else {
            clearSelection();
          }
        });
      });

      // 10) stubs for save & report
      saveBtn.onclick   = () => alert("â–¶ applyEdits() to save back");
      reportBtn.onclick = () => alert("â–¶ generate your PDF report");

      clearSelection();
    });
  </script>
</body>
</html>
